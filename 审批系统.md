审批.md

一、总体设计目标与分层
- 目标
  - 支持多审批类型：财务、项目、合作者等；易扩展为人事等新类型。
  - 支持多节点类型：开始、结束、条件、审核、抄送、子流程等；支持会签（全体同意）/并签（任一同意）/子流程。
  - 分层清晰：Controller（接入）/Service（业务编排）/审批引擎（流程编排与节点处理）/Repository（持久化）。
  - 高内聚低耦合：节点处理与业务策略解耦；状态处理与通知解耦；可插拔式节点、审批类型、通知渠道。

- 分层与职责
  - Controller：参数校验、路由接入、异常处理（交由 Service）。
  - Service：事务控制、调用 Builder 组装、驱动审批引擎开始执行。
  - 审批引擎（Engine + Context）：按模板树推进节点，路由条件，生成任务，会签/并签判断，处理子流程，中止/驳回，驱动状态机变化。
  - Repository：封装 DB 写入。说明：本 Demo 完全遵循你提供的迁移和模型，不修改其定义。鉴于 FlowNodeRepositories/FlowNodeTaskRepositories 的 store 方法字段不匹配（approval_id/approval_node_id 与表结构不一致），创建节点与任务处使用模型直写，更新操作优先走 Repository 的 update。

二、设计模式应用与原因
- 策略模式（FlowTypeStrategy）
  - 为什么：不同业务类型（财务/项目）的标题、业务快照、默认回调、特殊前置校验不同。
  - 怎么用：按 business_type 选择策略类，生成 Flow 基础数据（title、snapshot、callback 等），以及对某些节点的扩展决策。

- 责任链模式（NodeHandler Chain）
  - 为什么：节点类型不断扩展，节点推进逻辑按类型分发，链式向后传递。
  - 怎么用：NodeHandlerInterface + AbstractNodeHandler，Factory 根据节点类型产出具体 Handler；Handler 内处理当前节点并返回下一个待处理节点。

- 状态模式（FlowState）
  - 为什么：审批整体状态（create/process/success/reject/cancel）的行为差异（是否允许继续推进、是否可驳回等）。
  - 怎么用：状态类实现 FlowStateInterface，FlowEngine 持有当前状态并委派处理 onEnter/onApprove/onReject/onCancel。

- 工厂方法/抽象工厂（StrategyFactory、NodeHandlerFactory）
  - 为什么：按业务类型/节点类型创建策略或处理器，避免分支膨胀。
  - 怎么用：通过 type 注册映射，工厂返回实例，新增类型仅新增类+注册映射。

- 观察者模式（Notifier）
  - 为什么：通知方式多（短信/邮件/站内信/回调），与流程、节点解耦。
  - 怎么用：引擎在关键事件（流程结束/驳回/子流程结束）发布事件，Notifier 订阅执行。

- 建造者模式（TemplateBuilder）
  - 为什么：流程模板/节点配置常按步骤构建（层级、并行/会签、子流程挂载），逐步设置。
  - 怎么用：构建 FlowTemplate + FlowNodeTemplate 层级树；本 Demo 提供示例 Builder（也可在管理端使用）。

- 组合模式（模板树）
  - 为什么：节点树存在父子层级、并行分支、子流程。对“节点”和“节点组”以统一方式处理。
  - 怎么用：FlowNodeTemplate 自引用 children/conditionNode，Engine 统一按树推进。

三、核心类设计（接口/抽象/实现）
1) 合同接口
- app/Flow/Contracts/FlowTypeStrategyInterface.php
```php
<?php
namespace App\Flow\Contracts;

use App\Models\FlowTemplate;

interface FlowTypeStrategyInterface
{
    // 生成审批实例的标题
    public function makeTitle(array $inputs, FlowTemplate $template): string;

    // 业务快照（用于条件判断、审计）
    public function makeBusinessSnapshot(array $inputs): array;

    // 创建前校验（如财务金额、项目预算）
    public function validateBeforeCreate(array $inputs, FlowTemplate $template): void;

    // 默认回调（可空）
    public function defaultCallback(array $inputs): ?array;
}
```

- app/Flow/Contracts/NodeHandlerInterface.php
```php
<?php
namespace App\Flow\Contracts;

use App\Models\Flow;
use App\Models\FlowNode;
use App\Models\FlowNodeTemplate;

interface NodeHandlerInterface
{
    // 处理模板节点 -> 创建/推进实例节点，返回下一个“应处理”的模板节点（可能为并行多个）
    public function handle(Flow $flow, FlowNodeTemplate $currentTemplateNode): array;

    // 当审批动作触发（同意/驳回/抄送）作用于某个节点实例时
    public function onAction(Flow $flow, FlowNode $node, string $action, array $payload = []): void;

    // 是否自动节点（无需人为交互，进入后立即推进）
    public function isAuto(): bool;
}
```

- app/Flow/Contracts/FlowStateInterface.php
```php
<?php
namespace App\Flow\Contracts;

use App\Models\Flow;

interface FlowStateInterface
{
    public function onEnter(Flow $flow): void;
    public function onApprove(Flow $flow): void; // 流转为成功
    public function onReject(Flow $flow, ?string $reason = null): void; // 驳回
    public function onCancel(Flow $flow, ?string $reason = null): void; // 取消
}
```

- app/Flow/Contracts/NotifierInterface.php
```php
<?php
namespace App\Flow\Contracts;

use App\Models\Flow;

interface NotifierInterface
{
    public function notify(string $event, Flow $flow, array $context = []): void;
}
```

2) 工厂
- app/Flow/Factory/FlowTypeStrategyFactory.php
```php
<?php
namespace App\Flow\Factory;

use App\Flow\Contracts\FlowTypeStrategyInterface;
use App\Flow\Types\FinanceFlowStrategy;
use App\Flow\Types\ProjectFlowStrategy;
use InvalidArgumentException;

class FlowTypeStrategyFactory
{
    public static function make(string $type): FlowTypeStrategyInterface
    {
        return match ($type) {
            'finance' => new FinanceFlowStrategy(),
            'project' => new ProjectFlowStrategy(),
            default   => throw new InvalidArgumentException("Unsupported business type: {$type}"),
        };
    }
}
```

- app/Flow/Factory/NodeHandlerFactory.php
```php
<?php
namespace App\Flow\Factory;

use App\Flow\Nodes\ApprovalNodeHandler;
use App\Flow\Nodes\CCNodeHandler;
use App\Flow\Nodes\ConditionNodeHandler;
use App\Flow\Nodes\EndNodeHandler;
use App\Flow\Nodes\StartNodeHandler;
use App\Flow\Nodes\SubflowNodeHandler;
use App\Flow\Contracts\NodeHandlerInterface;
use InvalidArgumentException;

class NodeHandlerFactory
{
    public static function make(string $type): NodeHandlerInterface
    {
        return match ($type) {
            'start'           => new StartNodeHandler(),
            'approval'        => new ApprovalNodeHandler(),
            'cc'              => new CCNodeHandler(),
            'condition',
            'condition_route' => new ConditionNodeHandler(),
            'subflow'         => new SubflowNodeHandler(),
            'end'             => new EndNodeHandler(),
            default           => throw new InvalidArgumentException("Unsupported node type: {$type}"),
        };
    }
}
```

3) 状态模式
- app/Flow/States/AbstractFlowState.php
```php
<?php
namespace App\Flow\States;

use App\Flow\Contracts\FlowStateInterface;
use App\Models\Flow;

abstract class AbstractFlowState implements FlowStateInterface
{
    public function onEnter(Flow $flow): void {}
    public function onApprove(Flow $flow): void {}
    public function onReject(Flow $flow, ?string $reason = null): void {}
    public function onCancel(Flow $flow, ?string $reason = null): void {}
}
```

- app/Flow/States/CreateState.php
```php
<?php
namespace App\Flow\States;

use App\Models\Flow;
use App\Repositories\FlowRepositories;

class CreateState extends AbstractFlowState
{
    public function __construct(private readonly FlowRepositories $flows) {}

    public function onEnter(Flow $flow): void
    {
        $this->flows->update($flow->id, ['status' => 'create']);
    }
}
```

- app/Flow/States/ProcessingState.php
```php
<?php
namespace App\Flow\States;

use App\Models\Flow;
use App\Repositories\FlowRepositories;

class ProcessingState extends AbstractFlowState
{
    public function __construct(private readonly FlowRepositories $flows) {}

    public function onEnter(Flow $flow): void
    {
        $this->flows->update($flow->id, ['status' => 'process']);
    }
}
```

- app/Flow/States/SuccessState.php
```php
<?php
namespace App\Flow\States;

use App\Models\Flow;
use App\Repositories\FlowRepositories;

class SuccessState extends AbstractFlowState
{
    public function __construct(private readonly FlowRepositories $flows) {}

    public function onEnter(Flow $flow): void
    {
        $this->flows->update($flow->id, ['status' => 'success']);
    }
}
```

- app/Flow/States/RejectState.php
```php
<?php
namespace App\Flow\States;

use App\Models\Flow;
use App\Repositories\FlowRepositories;

class RejectState extends AbstractFlowState
{
    public function __construct(private readonly FlowRepositories $flows) {}

    public function onEnter(Flow $flow): void
    {
        $this->flows->update($flow->id, ['status' => 'reject']);
    }
}
```

- app/Flow/States/CancelState.php
```php
<?php
namespace App\Flow\States;

use App\Models\Flow;
use App\Repositories\FlowRepositories;

class CancelState extends AbstractFlowState
{
    public function __construct(private readonly FlowRepositories $flows) {}

    public function onEnter(Flow $flow): void
    {
        $this->flows->update($flow->id, ['status' => 'cancel']);
    }
}
```

4) 观察者（通知中心）
- app/Flow/Notify/NotifyCenter.php
```php
<?php
namespace App\Flow\Notify;

use App\Flow\Contracts\NotifierInterface;
use App\Models\Flow;

class NotifyCenter
{
    /** @var NotifierInterface[] */
    private array $notifiers = [];

    public function register(NotifierInterface $notifier): void
    {
        $this->notifiers[] = $notifier;
    }

    public function publish(string $event, Flow $flow, array $context = []): void
    {
        foreach ($this->notifiers as $notifier) {
            $notifier->notify($event, $flow, $context);
        }
    }
}
```

- 简易通知器实现（示例）
```php
<?php
namespace App\Flow\Notify;

use App\Flow\Contracts\NotifierInterface;
use App\Models\Flow;
use Illuminate\Support\Facades\Log;

class LogNotifier implements NotifierInterface
{
    public function notify(string $event, Flow $flow, array $context = []): void
    {
        Log::info("[FlowNotify] {$event}", [
            'flow_id' => $flow->id,
            'type'    => $flow->business_type,
            'ctx'     => $context,
        ]);
    }
}
```

5) 节点处理器（责任链）
- app/Flow/Nodes/AbstractNodeHandler.php
```php
<?php
namespace App\Flow\Nodes;

use App\Flow\Contracts\NodeHandlerInterface;

abstract class AbstractNodeHandler implements NodeHandlerInterface
{
    public function isAuto(): bool
    {
        return false;
    }
}
```

- StartNodeHandler：进入即自动通过
```php
<?php
namespace App\Flow\Nodes;

use App\Flow\Contracts\NodeHandlerInterface;
use App\Flow\Factory\NodeHandlerFactory;
use App\Models\Flow;
use App\Models\FlowNode;
use App\Models\FlowNodeTemplate;

class StartNodeHandler extends AbstractNodeHandler implements NodeHandlerInterface
{
    public function isAuto(): bool { return true; }

    public function handle(Flow $flow, FlowNodeTemplate $current): array
    {
        // 创建节点实例并自动通过
        $node = \App\Models\FlowNode::query()->create([
            'parent_id' => null,
            'depth'     => $current->depth,
            'name'      => $current->name,
            'type'      => $current->type,
            'rules'     => $current->rules ?? [],
            'status'    => 'auto',
            'callback'  => $current->callback ?? null,
            'flow_id'   => $flow->id,
            'extend'    => null,
        ]);

        // 返回下一个模板节点（children）
        $next = [];
        if ($current->children) {
            $next[] = $current->children;
        }
        return $next;
    }

    public function onAction(Flow $flow, FlowNode $node, string $action, array $payload = []): void {}
}
```

- ApprovalNodeHandler：支持会签(all)/并签(any)
```php
<?php
namespace App\Flow\Nodes;

use App\Flow\Contracts\NodeHandlerInterface;
use App\Models\Flow;
use App\Models\FlowNode;
use App\Models\FlowNodeTemplate;
use App\Models\FlowNodeTask;
use Illuminate\Support\Arr;

class ApprovalNodeHandler extends AbstractNodeHandler implements NodeHandlerInterface
{
    public function handle(Flow $flow, FlowNodeTemplate $current): array
    {
        $node = \App\Models\FlowNode::query()->create([
            'parent_id' => null,
            'depth'     => $current->depth,
            'name'      => $current->name,
            'type'      => $current->type,
            'rules'     => $current->rules ?? [],
            'status'    => 'process',
            'callback'  => $current->callback ?? null,
            'flow_id'   => $flow->id,
        ]);

        $mode = Arr::get($current->rules, 'mode', 'any'); // any=并签, all=会签
        $approvers = Arr::get($current->rules, 'approvers', []);
        foreach ($approvers as $ap) {
            FlowNodeTask::query()->create([
                'approver_id'    => (string) Arr::get($ap, 'id'),
                'approver_name'  => (string) Arr::get($ap, 'name'),
                'approver_type'  => (string) Arr::get($ap, 'type', 'user'),
                'operation_info' => null,
                'status'         => 'process',
                'flow_node_id'   => $node->id,
            ]);
        }

        // 审批节点需要人为操作，先不推进
        return [];
    }

    public function onAction(Flow $flow, FlowNode $node, string $action, array $payload = []): void
    {
        // action: approve/reject
        if ($action === 'reject') {
            // 更新任务与节点为驳回
            if (!empty($payload['task_id'])) {
                \App\Models\FlowNodeTask::query()->where('id', $payload['task_id'])
                    ->update(['status' => 'reject', 'operation_info' => $payload['operation_info'] ?? null]);
            }
            \App\Models\FlowNode::query()->where('id', $node->id)->update(['status' => 'reject']);
            // 流程状态由引擎外层统一置为 reject
            return;
        }

        if ($action === 'approve') {
            if (!empty($payload['task_id'])) {
                \App\Models\FlowNodeTask::query()->where('id', $payload['task_id'])
                    ->update(['status' => 'approve', 'operation_info' => $payload['operation_info'] ?? null]);
            }

            $rules = $node->rules ?? [];
            $mode  = Arr::get($rules, 'mode', 'any');

            $allTasks = \App\Models\FlowNodeTask::query()->where('flow_node_id', $node->id)->get();
            $approved = $allTasks->where('status', 'approve');

            $passed = false;
            if ($mode === 'any') {
                $passed = $approved->count() >= 1;
                if ($passed) {
                    // 取消其他任务
                    \App\Models\FlowNodeTask::query()
                        ->where('flow_node_id', $node->id)
                        ->where('status', 'process')
                        ->update(['status' => 'cancel']);
                }
            } else { // all
                $passed = $approved->count() === $allTasks->count();
            }

            if ($passed) {
                \App\Models\FlowNode::query()->where('id', $node->id)->update(['status' => 'approve']);
            }
        }
    }

    public function isAuto(): bool { return false; }
}
```

- CCNodeHandler：创建抄送任务后直接通过
```php
<?php
namespace App\Flow\Nodes;

use App\Flow\Contracts\NodeHandlerInterface;
use App\Models\Flow;
use App\Models\FlowNodeTemplate;

class CCNodeHandler extends AbstractNodeHandler implements NodeHandlerInterface
{
    public function isAuto(): bool { return true; }

    public function handle(Flow $flow, FlowNodeTemplate $current): array
    {
        $node = \App\Models\FlowNode::query()->create([
            'depth'     => $current->depth,
            'name'      => $current->name,
            'type'      => $current->type,
            'rules'     => $current->rules ?? [],
            'status'    => 'auto',
            'callback'  => $current->callback ?? null,
            'flow_id'   => $flow->id,
        ]);
        // 也可生成阅读任务（status=auto/skip）
        return $current->children ? [$current->children] : [];
    }

    public function onAction(\App\Models\Flow $flow, \App\Models\FlowNode $node, string $action, array $payload = []): void {}
}
```

- ConditionNodeHandler：基于业务快照做简单表达式判定
```php
<?php
namespace App\Flow\Nodes;

use App\Flow\Contracts\NodeHandlerInterface;
use App\Models\Flow;
use App\Models\FlowNodeTemplate;
use Illuminate\Support\Arr;

class ConditionNodeHandler extends AbstractNodeHandler implements NodeHandlerInterface
{
    public function isAuto(): bool { return true; }

    public function handle(Flow $flow, FlowNodeTemplate $current): array
    {
        \App\Models\FlowNode::query()->create([
            'depth'     => $current->depth,
            'name'      => $current->name,
            'type'      => $current->type,
            'rules'     => $current->rules ?? [],
            'status'    => 'auto',
            'callback'  => $current->callback ?? null,
            'flow_id'   => $flow->id,
        ]);

        $snapshot = $flow->business_snapshot ?? [];
        $routes   = $current->conditionNode ?? collect();
        $next = [];
        foreach ($routes as $routeNode) {
            // 约定：routeNode.rules.expression 如 "amount > 10000"
            $expr = Arr::get($routeNode->rules ?? [], 'expression');
            if ($expr && $this->evaluate($expr, $snapshot)) {
                $next[] = $routeNode->children; // 命中该路由的后续子节点
                break; // 命中一个后即跳出
            }
        }
        return array_filter($next);
    }

    private function evaluate(string $expr, array $vars): bool
    {
        // 简易、安全表达式（仅支持 amount、budget 等数值比较）
        // 示例：amount > 10000
        $allowed = ['amount', 'budget', 'cost'];
        foreach ($allowed as $k) {
            $expr = preg_replace('/\b'.$k.'\b/', (string) ((float) ($vars[$k] ?? 0)), $expr);
        }
        // 仅允许数字/空格/比较符/括号
        if (!preg_match('/^[0-9\.\s\(\)\>\<\=\!\&\|]+$/', $expr)) {
            return false;
        }
        return (bool) eval("return (".$expr.");");
    }

    public function onAction(\App\Models\Flow $flow, \App\Models\FlowNode $node, string $action, array $payload = []): void {}
}
```

- SubflowNodeHandler：生成子流程，当前节点等待子流程结束
```php
<?php
namespace App\Flow\Nodes;

use App\Flow\Contracts\NodeHandlerInterface;
use App\Models\Flow;
use App\Models\FlowNodeTemplate;
use Illuminate\Support\Arr;

class SubflowNodeHandler extends AbstractNodeHandler implements NodeHandlerInterface
{
    public function handle(Flow $flow, FlowNodeTemplate $current): array
    {
        $node = \App\Models\FlowNode::query()->create([
            'depth'     => $current->depth,
            'name'      => $current->name,
            'type'      => $current->type,
            'rules'     => $current->rules ?? [],
            'status'    => 'process', // 等待子流程返回
            'callback'  => $current->callback ?? null,
            'flow_id'   => $flow->id,
        ]);

        $subTemplateId = Arr::get($current->rules, 'subflow_template_id');
        if ($subTemplateId) {
            // 生成子流程
            $child = \App\Models\Flow::query()->create([
                'parent_id'                   => $flow->id,
                'title'                       => $flow->title.'-子流程',
                'business_type'               => $flow->business_type, // 或者不同类型
                'business_id'                 => $flow->business_id,
                'business_snapshot'           => $flow->business_snapshot,
                'status'                      => 'process',
                'flow_node_template_snapshot' => null,
                'callback'                    => null,
                'applicant_type'              => $flow->applicant_type,
                'applicant_id'                => $flow->applicant_id,
                'extend'                      => ['parent_node_id' => $node->id],
                'flow_template_id'            => $subTemplateId,
            ]);
            // 引擎外部监听子流程结束后，将当前节点置为 approve 并推进
        }

        return []; // 等待子流程
    }

    public function onAction(\App\Models\Flow $flow, \App\Models\FlowNode $node, string $action, array $payload = []): void {}
}
```

- EndNodeHandler：终止流程
```php
<?php
namespace App\Flow\Nodes;

use App\Flow\Contracts\NodeHandlerInterface;
use App\Models\Flow;
use App\Models\FlowNodeTemplate;

class EndNodeHandler extends AbstractNodeHandler implements NodeHandlerInterface
{
    public function isAuto(): bool { return true; }

    public function handle(Flow $flow, FlowNodeTemplate $current): array
    {
        \App\Models\FlowNode::query()->create([
            'depth'     => $current->depth,
            'name'      => $current->name,
            'type'      => $current->type,
            'rules'     => $current->rules ?? [],
            'status'    => 'auto',
            'callback'  => $current->callback ?? null,
            'flow_id'   => $flow->id,
        ]);
        return []; // 无后续
    }

    public function onAction(\App\Models\Flow $flow, \App\Models\FlowNode $node, string $action, array $payload = []): void {}
}
```

6) 审批引擎/上下文
- app/Flow/Engine/FlowEngine.php
```php
<?php
namespace App\Flow\Engine;

use App\Flow\Factory\NodeHandlerFactory;
use App\Flow\Notify\NotifyCenter;
use App\Flow\States\ProcessingState;
use App\Flow\States\RejectState;
use App\Flow\States\SuccessState;
use App\Models\Flow;
use App\Models\FlowNode;
use App\Models\FlowNodeTemplate;
use App\Repositories\FlowRepositories;
use Illuminate\Support\Collection;

class FlowEngine
{
    public function __construct(
        private readonly FlowRepositories $flows,
        private readonly NotifyCenter $notifier,
    ) {}

    // 启动流程：根据模板树从 start 开始推进，直到遇到需要人工的节点或结束
    public function start(Flow $flow, FlowNodeTemplate $root): void
    {
        (new ProcessingState($this->flows))->onEnter($flow);
        $this->advance($flow, [$root]);
    }

    // 推进：依次处理节点，自动节点继续推进，人工节点停止由外部触发
    public function advance(Flow $flow, array $templateNodes): void
    {
        $queue = $templateNodes;
        while (!empty($queue)) {
            /** @var FlowNodeTemplate $tpl */
            $tpl = array_shift($queue);
            $handler = NodeHandlerFactory::make($tpl->type);
            $next = $handler->handle($flow, $tpl);

            // 自动节点：继续推进；审批节点：停止
            if (!empty($next) && $handler->isAuto()) {
                foreach ($next as $n) {
                    if ($n instanceof FlowNodeTemplate) {
                        $queue[] = $n;
                    }
                }
            } elseif (!$handler->isAuto()) {
                // 人工节点暂停
                break;
            } else {
                // 可能是 end
                if ($tpl->type === 'end') {
                    (new SuccessState($this->flows))->onEnter($flow);
                    $this->notifier->publish('flow.success', $flow);
                    break;
                }
            }
        }
    }

    // 节点动作触发（审批/驳回）
    public function action(Flow $flow, FlowNode $node, string $action, array $payload = []): void
    {
        $handler = NodeHandlerFactory::make($node->type);
        $handler->onAction($flow, $node, $action, $payload);

        $node->refresh();
        if ($node->status === 'reject') {
            (new RejectState($this->flows))->onEnter($flow);
            $this->notifier->publish('flow.reject', $flow, ['node_id' => $node->id]);
            return;
        }

        if ($node->status === 'approve') {
            // 找到模板中该节点，推进其 children
            $tplNode = FlowNodeTemplate::query()->where('flow_template_id', $flow->flow_template_id)
                ->where('name', $node->name) // 简化匹配: 同名
                ->first();
            $next = [];
            if ($tplNode && $tplNode->children) {
                $next[] = $tplNode->children;
            } else {
                // 若无后续且为 end 则成功
                // 这里由 advance 中处理
            }
            if (!empty($next)) {
                $this->advance($flow, $next);
            } else {
                // 无后续则视为结束
                (new SuccessState($this->flows))->onEnter($flow);
                $this->notifier->publish('flow.success', $flow);
            }
        }
    }
}
```

- app/Flow/Builder.php（建造者 + 业务策略 + 快照）
```php
<?php
namespace App\Flow;

use App\Flow\Factory\FlowTypeStrategyFactory;
use App\Flow\Engine\FlowEngine;
use App\Models\Flow;
use App\Models\FlowTemplate;
use App\Repositories\FlowRepositories;
use Illuminate\Support\Arr;

class Builder
{
    public function __construct(
        private readonly FlowRepositories $flows,
        private readonly FlowEngine $engine,
    ) {}

    // 根据业务类型和输入创建审批实例并启动
    public function buildAndStart(string $type, array $inputs): Flow
    {
        $strategy = FlowTypeStrategyFactory::make($type);

        $template = FlowTemplate::query()
            ->where('type', $type)
            ->where('status', 'enable')
            ->with(['nodeTemplate.children', 'nodeTemplate.conditionNode'])
            ->firstOrFail();

        $strategy->validateBeforeCreate($inputs, $template);

        $flow = $this->flows->store([
            'parent_id'                   => Arr::get($inputs, 'parent_id'),
            'title'                       => $strategy->makeTitle($inputs, $template),
            'business_type'               => $type,
            'business_id'                 => (string) Arr::get($inputs, 'business_id'),
            'business_snapshot'           => $strategy->makeBusinessSnapshot($inputs),
            'status'                      => 'create',
            'flow_node_template_snapshot' => $template->toArray(), // 快照
            'callback'                    => $strategy->defaultCallback($inputs),
            'applicant_type'              => (string) Arr::get($inputs, 'applicant_type', 'user'),
            'applicant_id'                => (string) Arr::get($inputs, 'applicant_id'),
            'extend'                      => Arr::get($inputs, 'extend', []),
            'flow_template_id'            => $template->id,
        ]);

        // 启动流程
        $this->engine->start($flow, $template->nodeTemplate);

        return $flow;
    }
}
```

7) 业务类型策略实现（两个示例）
- app/Flow/Types/FinanceFlowStrategy.php
```php
<?php
namespace App\Flow\Types;

use App\Flow\Contracts\FlowTypeStrategyInterface;
use App\Models\FlowTemplate;
use Illuminate\Support\Arr;
use InvalidArgumentException;

class FinanceFlowStrategy implements FlowTypeStrategyInterface
{
    public function makeTitle(array $inputs, FlowTemplate $template): string
    {
        $amount = number_format((float) Arr::get($inputs, 'amount', 0), 2);
        return "【财务】报销审批-金额{$amount}";
    }

    public function makeBusinessSnapshot(array $inputs): array
    {
        return [
            'amount' => (float) Arr::get($inputs, 'amount', 0),
            'reason' => (string) Arr::get($inputs, 'reason', ''),
            'cost'   => (float) Arr::get($inputs, 'cost', 0),
        ];
    }

    public function validateBeforeCreate(array $inputs, FlowTemplate $template): void
    {
        $amount = (float) Arr::get($inputs, 'amount', 0);
        if ($amount <= 0) {
            throw new InvalidArgumentException('金额必须大于 0');
        }
    }

    public function defaultCallback(array $inputs): ?array
    {
        return Arr::get($inputs, 'callback'); // 可传入第三方回调
    }
}
```

- app/Flow/Types/ProjectFlowStrategy.php
```php
<?php
namespace App\Flow\Types;

use App\Flow\Contracts\FlowTypeStrategyInterface;
use App\Models\FlowTemplate;
use Illuminate\Support\Arr;

class ProjectFlowStrategy implements FlowTypeStrategyInterface
{
    public function makeTitle(array $inputs, FlowTemplate $template): string
    {
        return "【项目】立项审批-".(string) Arr::get($inputs, 'project_name', '未知项目');
    }

    public function makeBusinessSnapshot(array $inputs): array
    {
        return [
            'project_name' => (string) Arr::get($inputs, 'project_name'),
            'budget'       => (float) Arr::get($inputs, 'budget', 0),
            'owner_id'     => (string) Arr::get($inputs, 'owner_id'),
            'amount'       => (float) Arr::get($inputs, 'budget', 0), // 供条件节点复用
        ];
    }

    public function validateBeforeCreate(array $inputs, FlowTemplate $template): void
    {
        // 可加入项目信息校验
    }

    public function defaultCallback(array $inputs): ?array
    {
        return null;
    }
}
```

四、Demo（可直接落地到 Laravel）
1) 路由
```php
// routes/web.php
Route::post('/flow/{type}/create', [\App\Http\Controllers\Web\V1\FlowController::class, 'create']);
```

2) 控制器（已提供，保持不变）

3) 服务层实现
- app/Services/FlowService.php（在你的基础上完善）
```php
<?php
declare(strict_types=1);

namespace App\Services;

use App\Flow\Builder;
use Illuminate\Http\JsonResponse;
use Illuminate\Support\Facades\DB;
use Service\Common\Library\Response\ApiResponse;

readonly class FlowService
{
    public function __construct(
        private Builder $flowBuilder,
    ) {}

    public function create(string $type, array $inputs): JsonResponse
    {
        DB::beginTransaction();
        try {
            $flow = $this->flowBuilder->buildAndStart($type, $inputs);

            DB::commit();
            return ApiResponse::success([
                'flow_id'   => $flow->id,
                'status'    => $flow->status,
                'title'     => $flow->title,
                'type'      => $flow->business_type,
            ]);
        } catch (\Throwable $e) {
            DB::rollBack();
            return ApiResponse::fail(message: $e->getMessage());
        }
    }
}
```

4) 审批动作接口（可选扩展）
- 新增一个控制器方法便于演示审批动作
```php
// routes/web.php
Route::post('/flow/{flowId}/node/{nodeId}/action', [\App\Http\Controllers\Web\V1\FlowActionController::class, 'action']);

// app/Http/Controllers/Web/V1/FlowActionController.php
<?php
namespace App\Http\Controllers\Web\V1;

use App\Http\Controllers\Controller;
use App\Flow\Engine\FlowEngine;
use App\Models\Flow;
use App\Models\FlowNode;
use Illuminate\Http\Request;
use Illuminate\Http\JsonResponse;

class FlowActionController extends Controller
{
    public function __construct(private readonly FlowEngine $engine) {}

    public function action(string $flowId, string $nodeId, Request $request): JsonResponse
    {
        $flow = Flow::query()->findOrFail($flowId);
        $node = FlowNode::query()->findOrFail($nodeId);

        $this->engine->action($flow, $node, (string) $request->get('action'), [
            'task_id'         => $request->get('task_id'),
            'operation_info'  => $request->get('operation_info'),
        ]);

        return response()->json(['ok' => true]);
    }
}
```

5) 通知中心注册（ServiceProvider）
```php
// app/Providers/AppServiceProvider.php (register 或 boot 中)
use App\Flow\Notify\NotifyCenter;
use App\Flow\Notify\LogNotifier;

public function register()
{
    $this->app->singleton(NotifyCenter::class, function () {
        $nc = new NotifyCenter();
        $nc->register(new LogNotifier());
        return $nc;
    });
}
```

6) 示例模板（Seeder）
- database/seeders/FlowTemplateSeeder.php
```php
<?php
namespace Database\Seeders;

use Illuminate\Database\Seeder;
use App\Models\FlowTemplate;
use App\Models\FlowNodeTemplate;

class FlowTemplateSeeder extends Seeder
{
    public function run(): void
    {
        // 财务审批模板（start -> condition(amount) -> approval -> end）
        $finance = FlowTemplate::query()->create([
            'type'   => 'finance',
            'name'   => '财务报销',
            'status' => 'enable',
        ]);
        $start = FlowNodeTemplate::query()->create([
            'depth' => 1, 'name' => '开始', 'type' => 'start', 'flow_template_id' => $finance->id,
        ]);
        $cond = FlowNodeTemplate::query()->create([
            'parent_id' => $start->id, 'depth' => 2, 'name' => '金额条件', 'type' => 'condition',
            'rules' => [], 'flow_template_id' => $finance->id,
        ]);
        $routeHigh = FlowNodeTemplate::query()->create([
            'parent_id' => $cond->id, 'depth' => 3, 'name' => '大额路由', 'type' => 'condition_route',
            'rules' => ['expression' => 'amount > 10000'], 'flow_template_id' => $finance->id,
        ]);
        $routeLow = FlowNodeTemplate::query()->create([
            'parent_id' => $cond->id, 'depth' => 3, 'name' => '小额路由', 'type' => 'condition_route',
            'rules' => ['expression' => 'amount <= 10000'], 'flow_template_id' => $finance->id,
        ]);
        $approveHigh = FlowNodeTemplate::query()->create([
            'parent_id' => $routeHigh->id, 'depth' => 4, 'name' => 'CFO+CEO审批', 'type' => 'approval',
            'rules' => [
                'mode' => 'all',
                'approvers' => [
                    ['id' => 'u100', 'name' => 'CFO张', 'type' => 'admin'],
                    ['id' => 'u200', 'name' => 'CEO李', 'type' => 'admin'],
                ],
            ],
            'flow_template_id' => $finance->id,
        ]);
        $approveLow = FlowNodeTemplate::query()->create([
            'parent_id' => $routeLow->id, 'depth' => 4, 'name' => '部门经理审批', 'type' => 'approval',
            'rules' => [
                'mode' => 'any',
                'approvers' => [
                    ['id' => 'u300', 'name' => '经理王', 'type' => 'admin'],
                    ['id' => 'u301', 'name' => '副经理赵', 'type' => 'admin'],
                ],
            ],
            'flow_template_id' => $finance->id,
        ]);
        $end1 = FlowNodeTemplate::query()->create([
            'parent_id' => $approveHigh->id, 'depth' => 5, 'name' => '结束', 'type' => 'end', 'flow_template_id' => $finance->id,
        ]);
        $end2 = FlowNodeTemplate::query()->create([
            'parent_id' => $approveLow->id, 'depth' => 5, 'name' => '结束', 'type' => 'end', 'flow_template_id' => $finance->id,
        ]);

        // 项目审批模板（start -> approval(项目经理) -> subflow(财务) -> cc -> end）
        $project = FlowTemplate::query()->create([
            'type' => 'project', 'name' => '项目立项', 'status' => 'enable',
        ]);
        $pStart = FlowNodeTemplate::query()->create([
            'depth' => 1, 'name' => '开始', 'type' => 'start', 'flow_template_id' => $project->id,
        ]);
        $pApprove = FlowNodeTemplate::query()->create([
            'parent_id' => $pStart->id, 'depth' => 2, 'name' => '项目经理审批', 'type' => 'approval',
            'rules' => [
                'mode' => 'any',
                'approvers' => [
                    ['id' => 'pm001', 'name' => '项目经理A', 'type' => 'admin'],
                ],
            ],
            'flow_template_id' => $project->id,
        ]);
        $pSub = FlowNodeTemplate::query()->create([
            'parent_id' => $pApprove->id, 'depth' => 3, 'name' => '财务子流程', 'type' => 'subflow',
            'rules' => ['subflow_template_id' => $finance->id],
            'flow_template_id' => $project->id,
        ]);
        $pCC = FlowNodeTemplate::query()->create([
            'parent_id' => $pSub->id, 'depth' => 4, 'name' => '抄送财务部', 'type' => 'cc',
            'rules' => ['users' => [['id' => 'fin-cc', 'name' => '财务群']]],
            'flow_template_id' => $project->id,
        ]);
        $pEnd = FlowNodeTemplate::query()->create([
            'parent_id' => $pCC->id, 'depth' => 5, 'name' => '结束', 'type' => 'end', 'flow_template_id' => $project->id,
        ]);
    }
}
```

7) 示例调用与流程演示
- 创建财务审批
  - POST /flow/finance/create
  - body:
```json
{
  "business_id": "biz-1001",
  "applicant_id": "user-1",
  "amount": 12000,
  "reason": "差旅报销"
}
```
  - 结果：创建流程，start->condition 命中大额路由->生成审批任务(CFO、CEO 会签)，流程状态 process，等待审批。

- CFO 同意
  - POST /flow/{flowId}/node/{approvalNodeId}/action
```json
{
  "action": "approve",
  "task_id": "{cfo_task_id}",
  "operation_info": {"comment": "同意"}
}
```
  - 若 CEO 也同意，则该节点 approve，引擎推进至 end，流程 success，触发通知。

- 创建项目审批（包含子流程）
  - POST /flow/project/create
```json
{
  "business_id": "proj-9",
  "applicant_id": "user-2",
  "project_name": "新零售数据平台",
  "budget": 8000,
  "owner_id": "pm001"
}
```
  - 结果：项目经理审批通过后触发子流程（财务模板），父流程在“财务子流程”节点等待。子流程通过后，父流程节点标记 approve，继续 cc -> end，流程 success。

说明：子流程回传的联动示例
- 可通过监听子流程成功事件，在 Parent Flow 的 subflow 节点上执行：
```php
// 伪代码（可在事件监听器中）：
$parentNodeId = $childFlow->extend['parent_node_id'] ?? null;
if ($parentNodeId) {
    \App\Models\FlowNode::query()->where('id', $parentNodeId)->update(['status' => 'approve']);
    $parent = \App\Models\Flow::query()->find($childFlow->parent_id);
    app(\App\Flow\Engine\FlowEngine::class)->action($parent, \App\Models\FlowNode::query()->find($parentNodeId), 'approve');
}
```

五、扩展性说明：新增审批类型（如人事审批 HR）
1) 新增策略类
- app/Flow/Types/HrFlowStrategy.php 实现 FlowTypeStrategyInterface，定义 makeTitle/makeBusinessSnapshot/validateBeforeCreate/defaultCallback。

2) 注册到工厂
- 在 FlowTypeStrategyFactory::make 增加 'hr' => new HrFlowStrategy()。

3) 新增模板
- 通过后台或 Seeder 创建 type=hr 的 FlowTemplate 和节点树（start->approval(HR)->end 或复杂流程）。

4) 无需改引擎、状态机、通知器、节点处理器。若有 HR 专属节点类型（例如“试用期检查”），只需新增 NodeHandler 实现并在 NodeHandlerFactory 注册映射。

六、与数据库/Repository 的一致性与注意
- 本方案严格不修改你提供的迁移/模型/仓库代码。由于 FlowNodeRepositories::store 和 FlowNodeTaskRepositories::store 的字段与表结构存在不一致（approval_id/approval_node_id），本 Demo 在“创建节点/任务”时直接使用对应 Model::query()->create 写入；在状态更新时可复用仓库的 update。
- 字段含义遵循迁移注释，所有 JSON 字段使用 casts=json；时间字段由基类格式化。
- 可选使用 Redis
  - 缓存模板树：key: flow:tpl:{template_id}，减少模板查询。
  - 并发控制：流程推进时可对 flow:{id} 加互斥锁，避免重复推进。

七、简要类清单（放置路径）
- app/Flow/Contracts/FlowTypeStrategyInterface.php
- app/Flow/Contracts/NodeHandlerInterface.php
- app/Flow/Contracts/FlowStateInterface.php
- app/Flow/Contracts/NotifierInterface.php
- app/Flow/Factory/FlowTypeStrategyFactory.php
- app/Flow/Factory/NodeHandlerFactory.php
- app/Flow/States/{CreateState,ProcessingState,SuccessState,RejectState,CancelState}.php
- app/Flow/Notify/{NotifyCenter,LogNotifier}.php
- app/Flow/Nodes/{AbstractNodeHandler,StartNodeHandler,ApprovalNodeHandler,CCNodeHandler,ConditionNodeHandler,SubflowNodeHandler,EndNodeHandler}.php
- app/Flow/Engine/FlowEngine.php
- app/Flow/Builder.php
- app/Services/FlowService.php（按上文实现）
- database/seeders/FlowTemplateSeeder.php
- 可选：app/Http/Controllers/Web/V1/FlowActionController.php

八、场景匹配表（回顾）
- 审批模版创建（节点配置）：建造者模式（Builder）按步骤构建模板树。
- 节点支持子流程/并行：组合模式（模板树 children/conditionNode）。
- 业务触发创建审批流：工厂模式（FlowTypeStrategyFactory）产出不同业务流策略；Builder 统一装配。
- 审批流状态流转：状态模式（Create/Processing/Success/Reject/Cancel）。
- 同意/驳回/子流程操作：策略/节点处理器实现，ApprovalNodeHandler、SubflowNodeHandler。
- 节点逐级流转：责任链/处理器工厂，FlowEngine 调用 handler->handle/onAction。
- 审批结束后通知：观察者模式，NotifyCenter + Notifier。

九、结语
- 本方案在不修改你提供的迁移/模型/仓库的前提下，提供了可运行的最小闭环 Demo：创建审批（财务/项目）、节点推进、会签/并签、子流程、结束通知。后续新增审批类型或节点类型，均可通过新增策略/处理器类与工厂注册完成扩展，保持引擎内核稳定。