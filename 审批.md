### 1、下面是我的迁移文件
```php
Schema::create('flow_template', function (Blueprint $table) {
    $table->ulid('id')->primary()->comment('主键');
    $table->enum('type', ['partner', 'publisher', 'finance', 'execution', 'workflow', 'project'])->comment('流程类型[partner:合作者审批,publisher:发布者审批,finance:财务审批,execution:执行流审批,workflow:工作流审批,project:项目审批]');
    $table->string('name')->comment('名称');
    $table->json('callback')->nullable()->comment('回调');
    $table->string('remark')->nullable()->comment('备注');
    $table->enum('status', ['enable', 'disable'])->default('enable')->comment('状态[enable:启用,disable:禁用]');
    MigrationHelper::createAndAdmin($table);
    $table->index('type');
    $table->comment('审批流程模版表');
});
Schema::create('flow_node_template', function (Blueprint $table) {
    $table->ulid('id')->primary()->comment('主键');
    $table->ulid('parent_id')->nullable()->comment('父级id');
    $table->unsignedTinyInteger('depth')->default(1)->comment('步骤');
    $table->string('name')->comment('名称');
    $table->string('description')->nullable()->comment('描述');
    $table->enum('type', ['condition', 'approval', 'cc', 'subflow'])->comment('类型[condition:条件节点,approval:审核节点,cc:抄送节点,subflow:子流程节点]');
    $table->json('rules')->nullable()->comment('审批规则');
    $table->json('callback')->nullable()->comment('回调');
    $table->ulid('flow_template_id')->comment('流程模版id');
    MigrationHelper::createAndAdmin($table);
    $table->index('parent_id');
    $table->index('flow_template_id');
    $table->comment('审批节点模版表');
});
Schema::create('flow', function (Blueprint $table) {
    $table->ulid('id')->primary()->comment('主键');
    $table->ulid('parent_id')->nullable()->comment('父级id');
    $table->string('title')->comment('标题');
    $table->enum('business_type', ['partner', 'publisher', 'finance', 'execution', 'workflow', 'project'])->comment('类型[partner:合作者审批,publisher:发布者审批,finance:财务审批,execution:执行流审批,workflow:工作流审批,project:项目审批]');
    $table->ulid('business_id')->comment('业务id');
    $table->json('business_snapshot')->nullable()->comment('业务快照');
    $table->enum('status', ['create', 'process', 'success', 'reject', 'cancel'])->comment('状态[create:创建,process:进行中,success:通过,reject:驳回,cancel:取消]');
    $table->json('flow_node_template_snapshot')->nullable()->comment('流程节点模版快照');
    $table->json('callback')->nullable()->comment('回调');
    $table->enum('applicant_type', ['user', 'admin'])->default('user')->comment('申请人类型[user:用户,admin:管理员]');
    $table->ulid('applicant_id')->comment('申请人id');
    $table->json('extend')->nullable()->comment('额外信息');
    $table->ulid('flow_template_id')->comment('流程模版id');
    MigrationHelper::createTime($table);
    $table->index(['business_type', 'business_id']);
    $table->index('status');
    $table->index('business_type');
    $table->comment('审批实例表');
});
Schema::create('flow_node', function (Blueprint $table) {
    $table->ulid('id')->primary()->comment('编号');
    $table->ulid('parent_id')->nullable()->comment('父级id');
    $table->unsignedTinyInteger('depth')->default(1)->comment('步骤');
    $table->string('name')->comment('节点名称');
    $table->enum('type', ['condition', 'approval', 'cc', 'subflow'])->default('approval')->comment('类型[condition:条件节点,approval:审核节点,cc:抄送节点,subflow:子流程节点]');
    $table->json('rules')->comment('审批规则');
    $table->enum('status', ['process', 'approve', 'reject', 'skip', 'auto', 'cancel'])->comment('状态[process:审批中,approve:通过,reject:驳回,skip:跳过,auto:自动,cancel:取消]');
    $table->json('callback')->nullable()->comment('回调');
    $table->ulid('flow_id')->comment('审批id');
    $table->json('extend')->nullable()->comment('额外信息');
    MigrationHelper::createTime($table);
    $table->index('parent_id');
    $table->index('flow_id');
    $table->comment('审批节点实例表');
});
Schema::create('flow_node_task', function (Blueprint $table) {
    $table->ulid('id')->primary()->comment('编号');
    $table->ulid('approver_id')->comment('审批人id');
    $table->string('approver_name')->comment('审批人名称');
    $table->string('approver_type')->comment('审批人类型');
    $table->json('operation_info')->nullable()->comment('操作信息');
    $table->enum('status', ['process', 'approve', 'reject', 'skip', 'auto', 'cancel'])->comment('状态[process:审批中,approve:通过,reject:驳回,skip:跳过,auto:自动,cancel:取消]');
    $table->ulid('flow_node_id')->comment('审批节点id');
    $table->json('extend')->nullable()->comment('额外信息');
    MigrationHelper::createAndAdmin($table);
    $table->comment('流程节点任务实例表');
});
```
### 2、模型
```php
<?php

declare(strict_types=1);

namespace App\Models;

use Illuminate\Database\Eloquent\SoftDeletes;

/**
 * @property string $id
 * @property string $parent_id
 * @property string $title
 * @property string $business_type
 * @property string $business_id
 * @property string $status
 * @property array $flow_node_template_snapshot
 * @property array $callback
 * @property string $applicant_type
 * @property string $applicant_id
 * @property array $extend
 * @property string $flow_template_id
 * @property string $created_at
 * @property string $updated_at
 * @property string $deleted_at
 */
class Flow extends BaseModel
{
    use SoftDeletes;

    protected $table = 'flow';

    protected $casts = [
        'business_snapshot'           => 'json',
        'flow_node_template_snapshot' => 'json',
        'callback'                    => 'json',
        'extend'                      => 'json',
    ];

    protected $fillable = [
        'id',
        'parent_id',
        'title',
        'business_type',
        'business_id',
        'business_snapshot',
        'status',
        'flow_node_template_snapshot',
        'callback',
        'applicant_type',
        'applicant_id',
        'extend',
        'flow_template_id',
        'created_at',
        'updated_at',
        'deleted_at',
    ];

    protected array $resource = [
        'id'                          => 'string',
        'parent_id'                   => 'string',
        'title'                       => 'string',
        'business_type'               => 'string',
        'business_id'                 => 'string',
        'business_snapshot'           => 'array',
        'status'                      => 'string',
        'flow_node_template_snapshot' => 'array',
        'callback'                    => 'array',
        'applicant_type'              => 'string',
        'applicant_id'                => 'string',
        'extend'                      => 'array',
        'flow_template_id'            => 'string',
        'created_at'                  => 'string',
        'updated_at'                  => 'string',
        'deleted_at'                  => 'string',
    ];
}
```
```php
<?php

declare(strict_types=1);

namespace App\Models;

use Illuminate\Database\Eloquent\SoftDeletes;

/**
 * @property string $id
 * @property string $parent_id
 * @property string $type
 * @property string $depth
 * @property string $name
 * @property string $rules
 * @property string $status
 * @property array $callback
 * @property string $flow_id
 * @property array $extend
 * @property string $created_at
 * @property string $updated_at
 * @property string $deleted_at
 */
class FlowNode extends BaseModel
{
    use SoftDeletes;

    protected $table = 'flow_node';

    protected $casts = [
        'rules'    => 'json',
        'callback' => 'json',
        'extend'   => 'json',
    ];

    protected $fillable = [
        'id',
        'parent_id',
        'type',
        'depth',
        'name',
        'method',
        'status',
        'callback',
        'flow_id',
        'extend',
        'created_at',
        'updated_at',
        'deleted_at',
    ];

    protected array $resource = [
        'id'         => 'string',
        'parent_id'  => 'string',
        'type'       => 'string',
        'depth'      => 'string',
        'name'       => 'string',
        'method'     => 'string',
        'status'     => 'string',
        'callback'   => 'array',
        'flow_id'    => 'string',
        'extend'     => 'array',
        'created_at' => 'string',
        'updated_at' => 'string',
        'deleted_at' => 'string',
    ];
}
```
```php
<?php

declare(strict_types=1);

namespace App\Models;

use Illuminate\Database\Eloquent\SoftDeletes;

/**
 * @property string $id
 * @property string $approval_id
 * @property string $approver_name
 * @property string $approver_type
 * @property array $operation_info
 * @property string $status
 * @property string $flow_node_id
 * @property array $extend
 * @property string $created_at
 * @property string $created_admin_id
 * @property string $updated_at
 * @property string $updated_admin_id
 * @property string $deleted_at
 * @property string $deleted_admin_id
 */
class FlowNodeTask extends BaseModel
{
    use SoftDeletes;

    protected $table = 'flow_node_task';

    protected $casts = [
        'operation_info' => 'json',
        'extend'         => 'json',
    ];

    protected $fillable = [
        'id',
        'approver_id',
        'approver_name',
        'approver_type',
        'operation_info',
        'status',
        'flow_node_id',
        'extend',
        'created_at',
        'created_admin_id',
        'updated_at',
        'updated_admin_id',
        'deleted_at',
        'deleted_admin_id',
    ];

    protected array $resource = [
        'id'               => 'string',
        'approver_id'      => 'string',
        'approver_name'    => 'string',
        'approver_type'    => 'string',
        'operation_info'   => 'array',
        'status'           => 'string',
        'flow_node_id'     => 'string',
        'extend'           => 'array',
        'created_at'       => 'string',
        'created_admin_id' => 'string',
        'updated_at'       => 'string',
        'updated_admin_id' => 'string',
        'deleted_at'       => 'string',
        'deleted_admin_id' => 'string',
    ];
}
```
```php
<?php

declare(strict_types=1);

namespace App\Models;

use Illuminate\Database\Eloquent\SoftDeletes;

/**
 * @property string $id
 * @property string $parent_id
 * @property string $depth
 * @property string $name
 * @property string $description
 * @property string $type
 * @property string $rules
 * @property array $callback
 * @property string $flow_template_id
 * @property string $created_at
 * @property string $created_admin_id
 * @property string $updated_at
 * @property string $updated_admin_id
 * @property string $deleted_at
 * @property string $deleted_admin_id
 */
class FlowNodeTemplate extends BaseModel
{
    use SoftDeletes;

    protected $table = 'flow_node_template';

    protected $casts = [
        'rules'    => 'json',
        'callback' => 'json',
    ];

    protected $fillable = [
        'id',
        'parent_id',
        'depth',
        'name',
        'description',
        'type',
        'rules',
        'callback',
        'flow_template_id',
        'created_at',
        'created_admin_id',
        'updated_at',
        'updated_admin_id',
        'deleted_at',
        'deleted_admin_id',
    ];

    protected array $resource = [
        'id'               => 'string',
        'parent_id'        => 'string',
        'depth'            => 'string',
        'name'             => 'string',
        'description'      => 'string',
        'type'             => 'string',
        'rules'            => 'string',
        'callback'         => 'array',
        'flow_template_id' => 'string',
    ];

    public function children()
    {
        return $this->hasMany(self::class, 'parent_id', 'id')->with('children');
    }
}
```
```php
<?php

declare(strict_types=1);

namespace App\Models;

use Illuminate\Database\Eloquent\Relations\HasOne;
use Illuminate\Database\Eloquent\SoftDeletes;

/**
 * @property string $id
 * @property string $type
 * @property string $name
 * @property array $callback
 * @property string $remark
 * @property string $status
 * @property string $created_at
 * @property string $created_admin_id
 * @property string $updated_at
 * @property string $updated_admin_id
 * @property string $deleted_at
 * @property string $deleted_admin_id
 */
class FlowTemplate extends BaseModel
{
    use SoftDeletes;

    protected $table = 'flow_template';

    protected $casts = [
        'callback' => 'json',
    ];

    protected $fillable = [
        'id',
        'type',
        'name',
        'callback',
        'remark',
        'status',
        'created_at',
        'created_admin_id',
        'updated_at',
        'updated_admin_id',
        'deleted_at',
        'deleted_admin_id',
    ];

    protected array $resource = [
        'id'       => 'string',
        'type'     => 'string',
        'name'     => 'string',
        'callback' => 'array',
        'remark'   => 'string',
        'status'   => 'string',
    ];

    /**
     * @return HasOne
     */
    public function nodeTemplate(): HasOne
    {
        return $this->hasOne(FlowNodeTemplate::class, 'flow_template_id', 'id');
    }
}
```
### 3、控制器层

```php
<?php

declare(strict_types=1);

namespace App\Http\Controllers\Web\V1;

use App\Http\Controllers\Controller;
use App\Http\Requests\Flow\FlowRequest;
use App\Services\FlowService;
use Illuminate\Http\JsonResponse;

class FlowController extends Controller
{
    public function __construct(
        private readonly FlowService $service,
    ) {}

    /**
     * 创建审批流程
     * @param  string  $type
     * @param  FlowRequest  $request
     * @return JsonResponse
     * @throws \Throwable
     */
    public function create(string $type, FlowRequest $request)
    {
        return $this->service->create($type, $request->all());
    }
}
```
### 4、服务层
```php
<?php

declare(strict_types=1);

namespace App\Services;

use App\Flow\Builder;
use Illuminate\Http\JsonResponse;
use Illuminate\Support\Facades\DB;
use Service\Common\Library\Response\ApiResponse;

readonly class FlowService
{
    public function __construct(
        private Builder $flowBuilder,
    ) {}

    /**
     * 创建审批流程
     * @param  string  $type
     * @param  array  $inputs
     * @return JsonResponse
     * @throws \Throwable
     */
    public function create(string $type, array $inputs): JsonResponse
    {
        DB::beginTransaction();
        try {
        
            DB::commit();

            return ApiResponse::success();
        } catch (\Exception $e) {
            DB::rollBack();

            return ApiResponse::fail(message: $e->getMessage());
        }
    }
}
```
### 5、仓库层
```php
<?php

declare(strict_types=1);

namespace App\Repositories;

use App\Models\FlowNode;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Arr;
use Illuminate\Support\Facades\DB;
use Service\Common\Base\BaseRepository;

class FlowNodeRepositories extends BaseRepository
{
    public function __construct(FlowNode $model)
    {
        $this->model = $model;
    }

    /**
     * 创建
     * @param  array  $inputs
     * @return Model
     */
    public function store(array $inputs): Model
    {
        return $this->query()->create([
            'parent_id'   => Arr::get($inputs, 'parent_id'),
            'depth'       => Arr::get($inputs, 'depth'),
            'name'        => Arr::get($inputs, 'name'),
            'type'        => Arr::get($inputs, 'type'),
            'rules'       => Arr::get($inputs, 'rules'),
            'status'      => Arr::get($inputs, 'status'),
            'callback'    => Arr::get($inputs, 'callback', DB::raw("'{}'")),
            'approval_id' => Arr::get($inputs, 'approval_id'),
            'extend'      => Arr::get($inputs, 'extend'),
        ]);
    }

    /**
     * 更新
     * @param  string  $id
     * @param  array  $inputs
     * @return int
     */
    public function update(string $id, array $inputs): int
    {
        return $this->query()->where('id', $id)->update([
            'status' => Arr::get($inputs, 'status'),
            'extend' => Arr::get($inputs, 'extend'),
        ]);
    }
}
```
```php
<?php

declare(strict_types=1);

namespace App\Repositories;

use App\Models\FlowNodeTask;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Arr;
use Illuminate\Support\Facades\DB;
use Service\Common\Base\BaseRepository;

class FlowNodeTaskRepositories extends BaseRepository
{
    public function __construct(FlowNodeTask $model)
    {
        $this->model = $model;
    }

    /**
     * 创建
     * @param  array  $inputs
     * @return Model
     */
    public function store(array $inputs): Model
    {
        return $this->query()->create([
            'approver_id'      => Arr::get($inputs, 'approver_id'),
            'approver_name'    => Arr::get($inputs, 'approver_name'),
            'approver_type'    => Arr::get($inputs, 'approver_type'),
            'operation_info'   => Arr::get($inputs, 'operation_info', DB::raw("'{}'")),
            'status'           => Arr::get($inputs, 'status'),
            'approval_node_id' => Arr::get($inputs, 'approval_node_id'),
            'extend'           => Arr::get($inputs, 'extend'),
        ]);
    }

    /**
     * 更新
     * @param  string  $id
     * @param  array  $inputs
     * @return int
     */
    public function update(string $id, array $inputs): int
    {
        return $this->query()->where('id', $id)->update([
            'operation_info' => Arr::get($inputs, 'operation_info', DB::raw("'{}'")),
            'status'         => Arr::get($inputs, 'status'),
            'extend'         => Arr::get($inputs, 'extend'),
        ]);
    }
}
```
```php
<?php

declare(strict_types=1);

namespace App\Repositories;

use App\Models\FlowNodeTemplate;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Arr;
use Illuminate\Support\Facades\DB;
use Service\Common\Base\BaseRepository;

class FlowNodeTemplateRepositories extends BaseRepository
{
    public function __construct(FlowNodeTemplate $model)
    {
        $this->model = $model;
    }

    /**
     * 创建
     * @param  array  $inputs
     * @return Model
     */
    public function store(array $inputs): Model
    {
        return $this->query()->create([
            'parent_id'        => Arr::get($inputs, 'parent_id'),
            'depth'            => Arr::get($inputs, 'depth'),
            'name'             => Arr::get($inputs, 'name'),
            'description'      => Arr::get($inputs, 'description'),
            'type'             => Arr::get($inputs, 'type'),
            'rules'            => Arr::get($inputs, 'rules', DB::raw("'{}'")),
            'callback'         => Arr::get($inputs, 'callback', DB::raw("'{}'")),
            'flow_template_id' => Arr::get($inputs, 'flow_template_id'),
        ]);
    }

    /**
     * 更新
     * @param  string  $id
     * @param  array  $data
     * @return int
     */
    public function update(string $id, array $data): int
    {
        return $this->query()->where('id', $id)->update([
            'parent_id'        => Arr::get($data, 'parent_id'),
            'depth'            => Arr::get($data, 'depth'),
            'name'             => Arr::get($data, 'name'),
            'description'      => Arr::get($data, 'description'),
            'type'             => Arr::get($data, 'type'),
            'rules'            => Arr::get($data, 'rules', DB::raw("'{}'")),
            'callback'         => Arr::get($data, 'callback', DB::raw("'{}'")),
            'flow_template_id' => Arr::get($data, 'flow_template_id'),
        ]);
    }
}
```
```php
<?php

declare(strict_types=1);

namespace App\Repositories;

use App\Models\Flow;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Arr;
use Illuminate\Support\Facades\DB;
use Service\Common\Base\BaseRepository;

class FlowRepositories extends BaseRepository
{
    public function __construct(Flow $model)
    {
        $this->model = $model;
    }

    /**
     * 创建
     * @param  array  $inputs
     * @return Model
     */
    public function store(array $inputs): Model
    {
        return $this->query()->create([
            'parent_id'                   => Arr::get($inputs, 'parent_id'),
            'title'                       => Arr::get($inputs, 'title'),
            'business_type'               => Arr::get($inputs, 'business_type'),
            'business_id'                 => Arr::get($inputs, 'business_id'),
            'business_snapshot'           => Arr::get($inputs, 'business_snapshot'),
            'status'                      => Arr::get($inputs, 'status'),
            'flow_node_template_snapshot' => Arr::get($inputs, 'flow_node_template_snapshot'),
            'callback'                    => Arr::get($inputs, 'callback', DB::raw("'{}'")),
            'applicant_type'              => Arr::get($inputs, 'applicant_type'),
            'applicant_id'                => Arr::get($inputs, 'applicant_id'),
            'extend'                      => Arr::get($inputs, 'extend'),
            'flow_template_id'            => Arr::get($inputs, 'flow_template_id'),
        ]);
    }

    /**
     * 更新
     * @param  string  $id
     * @param  array  $inputs
     * @return int
     */
    public function update(string $id, array $inputs): int
    {
        return $this->query()->where('id', $id)->update([
            'status'                      => Arr::get($inputs, 'status'),
            'flow_node_template_snapshot' => Arr::get($inputs, 'flow_node_template_snapshot'),
            'extend'                      => Arr::get($inputs, 'extend'),
        ]);
    }
}
```
```php
<?php

declare(strict_types=1);

namespace App\Repositories;

use App\Constants\Enums\FlowTemplate\Status;
use App\Models\FlowTemplate;
use Illuminate\Database\Eloquent\Collection;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Pagination\LengthAwarePaginator;
use Illuminate\Support\Arr;
use Illuminate\Support\Facades\DB;
use Service\Common\Base\BaseRepository;

class FlowTemplateRepositories extends BaseRepository
{
    public function __construct(FlowTemplate $model)
    {
        $this->model = $model;
    }

    /**
     * 分页
     * @param  array  $inputs
     * @return LengthAwarePaginator
     */
    public function page(array $inputs): LengthAwarePaginator
    {
        $query = $this->query();

        $query->when(! empty($inputs['type']), fn ($query) => $query->where('type', $inputs['type']));
        $query->when(! empty($inputs['status']), fn ($query) => $query->where('status', $inputs['status']));
        $query->when(! empty($inputs['name']), fn ($query) => $query->where('name', 'like', '%'.$inputs['name'].'%'));

        return $query->paginate($inputs['page_size']);
    }

    /**
     * 列表
     * @param  array  $inputs
     * @return Collection
     */
    public function list(array $inputs): Collection
    {
        $query = $this->query();

        $query->when(! empty($inputs['type']), fn ($query) => $query->where('type', $inputs['type']));
        $query->when(! empty($inputs['status']), fn ($query) => $query->where('status', $inputs['status']));

        return $query->get();
    }

    /**
     * 创建
     * @param  array  $inputs
     * @return Model
     */
    public function store(array $inputs): Model
    {
        return $this->query()->create([
            'type'     => Arr::get($inputs, 'type'),
            'name'     => Arr::get($inputs, 'name'),
            'callback' => Arr::get($inputs, 'callback', DB::raw("'{}'")),
            'remark'   => Arr::get($inputs, 'remark', ''),
            'status'   => Status::DISABLE->value,
        ]);
    }

    /**
     * 更新
     * @param  string  $id
     * @param  array  $inputs
     * @return int
     */
    public function update(string $id, array $inputs): int
    {
        return $this->query()->where('id', $id)->update([
            'name'     => Arr::get($inputs, 'name'),
            'callback' => Arr::get($inputs, 'callback', DB::raw("'{}'")),
            'remark'   => Arr::get($inputs, 'remark', ''),
        ]);
    }
}
```
