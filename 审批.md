你是一名拥有 10 年以上经验的高级架构师，精通 PHP（Laravel / ThinkPHP / Hyperf）、MySQL、Redis，熟悉 DDD（领域驱动设计）、微服务架构、以及常见的设计模式（策略模式、工厂方法模式/抽象工厂模式、责任链模式、状态模式、模板方法模式，观察者等）。  
你曾经参与过多个大型企业系统的架构设计，尤其擅长 **审批/工作流系统** 的建模与实现。

现在我需要你帮我设计一个 **审批系统**，要求如下：

## 1. 架构目标
- 系统要支持 **多种审批类型**（如通用审批、采购审批、自定义审批等），并且方便后续扩展新的审批类型，如果审批类型没有匹配，则默认为 **通用审批**。
- 系统要支持 **多种节点类型**，比如：开始节点、结束节点、条件节点、审核节点、抄送节点、子流程节点等。并且方便后续扩展新的节点类型。
- 审批流程要支持节点的行为操作：
    - **会签**（所有人同意才通过）
    - **并签**（任意一人同意即可通过）
    - **依次审批**（按照审批顺序创建审批任务，当前任务通过才能创建下一个任务）
- 审批动作包括：**同意、驳回、转让、转交、加签**。
- 架构要分层清晰：
    - **Controller 层**（接收请求）
    - **Service 层**（业务逻辑）
    - **审批引擎/上下文**（基于设计模式处理流程逻辑）不是单独的文件夹（平铺在app目录下）
    - **Repository 层**（数据库持久化）
- 系统要支持 **回调**，比如：
    - **通过、驳回**：发送短信、站内信、邮件、回调

## 2. 技术栈
- **语言/框架**：PHP 8.2 + Laravel
- **数据库**：MySQL（下面有迁移文件）
- **缓存**：Redis（可选）

## 3. 设计要求
- 使用 **设计模式** 提升扩展性，比如：
    - **策略模式**：处理不同审批类型（通用审批、采购审批、自定义审批…）、节点行为操作（会签、并签、依次审批…）
    - **责任链模式**：处理审批节点流转
    - **状态模式**：处理审批流状态（created:已创建,processing:进行中,waiting:等待中,approved:已通过,rejected:已驳回,canceled:已取消…）、节点状态（processing:审批中,approved:已通过,rejected:已驳回,skipped:已跳过,auto:自动处理,canceled:已取消…）、任务状态（pending:待处理,approved:已同意,rejected:已拒绝,transferred:已转交,forwarded:已转交,add_signed:已加签,skipped:已跳过,auto:自动处理,canceled:已取消…）
    - **工厂方法模式/抽象工厂模式**：动态创建不同审批流对象、节点对象、状态对象
    - **观察者模式**：处理通知短信、站内信、邮件、回调

- 每个模式的应用都要说明 **为什么选择它、怎么应用**。

## 4. 产出内容
1.**核心类设计**
    - 定义接口
    - 定义抽象类 & 实现类
    - 定义审批上下文/审批引擎类
2. **代码 Demo**
    - 给出一个 **简化版 Laravel Demo**（Controller + Service + Engine + Repository），能在 Laravel 项目中直接运行。
    - 示例中要包含两种审批类型（如财务审批、项目审批、包含子流程审批）的实现。
    - 给出一个示例流程（如「项目审批 → 节点流转 → 同意 → 驳回 → 子流程」）。
3. **扩展性说明**
    - 解释如果以后新增一个审批类型（比如人事审批），应该怎么做。

## 5. 风格要求
- 代码要符合 Laravel 规范。
- 按照设计模式，实现一个 **审批系统**。增加一个**通用审批**
- 每个类都要有简短的说明注释。
- 创建审批流程：，增加**草稿状态**（create），也可以直接提交 is_draft = true 创建草稿， is_draft = false 创建正式流程
- 特别注意：
    - **审批流程不要一次性创建**，而是**动态创建**。
    - **条件节点**：示例（审核节点1 → 条件路由 → (条件节点A → 审核2), (条件节点B → 审核3) → 主线继续 审核4 → 抄送 → 结束）
        - 条件节点是一种特殊的节点，它根据条件的结果来决定是否继续流转到下一个节点。
        - **比如目前节点执行到审核节点3，那我怎么样才能回到审核节点4，具体的审核模版看一下我的数据示例，给出具体的实现方案或方法**
- Demo 要尽可能简洁，但能完整体现设计模式的应用。

请按以上要求，产出完整的 **审批系统设计方案 + Demo**。

## 6. 下面是提供的部分代码
必须按照我给出的代码来完成，请勿自行修改。

## 7、下面是我的迁移文件
```php
Schema::create('flow_template', function (Blueprint $table) {
    $table->ulid('id')->primary()->comment('主键');
    $table->enum('type', ['general'])->comment('类型[general:通用审批]');
    $table->string('code', 50)->comment('标识');
    $table->string('name', 50)->comment('名称');
    $table->json('callback')->nullable()->comment('回调');
    $table->string('remark')->nullable()->comment('备注');
    $table->enum('status', ['enable', 'disable'])->default('enable')->comment('状态[enable:启用,disable:禁用]');
    MigrationHelper::createAndAdmin($table);
    $table->index('code');
    $table->comment('审批流程模版表');
});
Schema::create('flow_node_template', function (Blueprint $table) {
    $table->ulid('id')->primary()->comment('主键');
    $table->ulid('parent_id')->nullable()->comment('父级id');
    $table->unsignedTinyInteger('depth')->default(1)->comment('步骤');
    $table->unsignedTinyInteger('priority')->default(0)->comment('优先等级[数字越大优先级越高]');
    $table->string('name')->comment('名称');
    $table->string('description')->nullable()->comment('描述');
    $table->enum('type', ['start', 'condition', 'condition_route', 'approval', 'cc', 'subflow', 'end'])->comment('类型[start:开始节点,condition:条件节点,condition_route:条件路由节点,approval:审核节点,cc:抄送节点,subflow:子流程节点,end:结束节点]');
    $table->json('rules')->nullable()->comment('审批规则');
    $table->json('callback')->nullable()->comment('回调');
    $table->ulid('flow_template_id')->comment('流程模版id');
    MigrationHelper::createAndAdmin($table);
    $table->index('parent_id');
    $table->index('flow_template_id');
    $table->comment('审批节点模版表');
});
Schema::create('flow', function (Blueprint $table) {
    $table->ulid('id')->primary()->comment('主键');
    $table->string('title', 60)->comment('标题');
    $table->enum('type', ['general'])->comment('类型[general:通用审批]');
    $table->string('code', 50)->comment('标识');
    $table->ulid('parent_flow_id')->nullable()->comment('父级流程id');
    $table->ulid('parent_node_id')->nullable()->comment('父级节点id');
    $table->enum('level', ['main', 'subflow'])->comment('层级[main:主流程,subflow:子流程]');
    $table->ulid('business_id')->comment('业务id');
    $table->json('business_snapshot')->nullable()->comment('业务快照');
    $table->enum('status', [
        'created',
        'processing',
        'waiting',
        'approved',
        'rejected',
        'canceled',
    ])->comment('状态[created:已创建,processing:进行中,waiting:等待中,approved:已通过,rejected:已驳回,canceled:已取消]');
    $table->json('flow_node_template_snapshot')->nullable()->comment('流程节点模版快照');
    $table->json('callback')->nullable()->comment('回调');
    $table->enum('applicant_type', ['user', 'admin'])->default('user')->comment('申请人类型[user:用户,admin:管理员]');
    $table->ulid('applicant_id')->comment('申请人id');
    $table->json('extend')->nullable()->comment('额外信息');
    $table->ulid('flow_template_id')->comment('流程模版id');
    MigrationHelper::createTime($table);
    $table->index(['business_id']);
    $table->index(['applicant_type', 'applicant_id']);
    $table->index('code');
    $table->comment('审批实例表');
});
Schema::create('flow_node', function (Blueprint $table) {
    $table->ulid('id')->primary()->comment('编号');
    $table->ulid('parent_id')->nullable()->comment('父级id');
    $table->unsignedTinyInteger('depth')->default(1)->comment('步骤');
    $table->unsignedTinyInteger('priority')->default(0)->comment('优先等级[数字越大优先级越高]');
    $table->string('name')->comment('节点名称');
    $table->enum('type', ['start', 'condition', 'condition_route', 'approval', 'cc', 'subflow', 'end'])->comment('类型[start:开始节点,condition:条件节点,condition_route:条件路由节点,approval:审核节点,cc:抄送节点,subflow:子流程节点,end:结束节点]');
    $table->json('rules')->comment('审批规则');
    $table->enum('status', [
        'processing',
        'approved',
        'rejected',
        'skipped',
        'auto',
        'canceled',
    ])->comment('状态[processing:审批中,approved:已通过,rejected:已驳回,skipped:已跳过,auto:自动处理,canceled:已取消]');
    $table->json('callback')->nullable()->comment('回调');
    $table->ulid('flow_id')->comment('审批id');
    $table->json('extend')->nullable()->comment('额外信息');
    MigrationHelper::createTime($table);
    $table->index('parent_id');
    $table->index('flow_id');
    $table->comment('审批节点实例表');
});
Schema::create('flow_node_task', function (Blueprint $table) {
    $table->ulid('id')->primary()->comment('编号');
    $table->ulid('approver_id')->comment('审批人id');
    $table->string('approver_name')->comment('审批人名称');
    $table->string('approver_type')->comment('审批人类型');
    $table->json('operation_info')->nullable()->comment('操作信息');
    $table->enum('status', [
        'pending',
        'approved',
        'rejected',
        'transferred',
        'forwarded',
        'add_signed',
        'skipped',
        'auto',
        'canceled',
    ])->comment('状态[pending:待处理,approved:已同意,rejected:已拒绝,transferred:已转交,forwarded:已转交,add_signed:已加签,skipped:已跳过,auto:自动处理,canceled:已取消]');
    $table->ulid('flow_node_id')->comment('审批节点id');
    $table->json('extend')->nullable()->comment('额外信息');
    MigrationHelper::createAndAdmin($table);
    $table->comment('流程节点任务实例表');
});
```
### 2、枚举
```php
<?php

declare(strict_types=1);

namespace App\Constants\Enums\Flow;

use App\Constants\Enums\BaseEnumTrait;
use App\Constants\Enums\EnumInterface;

enum ApplicantType: string implements EnumInterface
{
    use BaseEnumTrait;

    case USER  = 'user';
    case ADMIN = 'admin';

    /**
     * 获取用户友好的标签
     * @return string
     */
    public function label(): string
    {
        return match ($this) {
            self::USER  => '用户',
            self::ADMIN => '管理员',
        };
    }
}
```
```php
<?php

namespace App\Constants\Enums\Flow;

use App\Constants\Enums\BaseEnumTrait;
use App\Constants\Enums\EnumInterface;

enum Type: string implements EnumInterface
{
    use BaseEnumTrait;

    case GENERAL = 'general';

    /**
     * 获取用户友好的标签
     * @return string
     */
    public function label(): string
    {
        return match ($this) {
            self::GENERAL => '通用审批',
        };
    }

    /**
     * @return string
     */
    public static function pattern(): string
    {
        return implode('|', self::values());
    }
}
```
```php
<?php

declare(strict_types=1);

namespace App\Constants\Enums\Flow;

use App\Constants\Enums\BaseEnumTrait;
use App\Constants\Enums\EnumInterface;

enum Level: string implements EnumInterface
{
    use BaseEnumTrait;

    case MAIN    = 'main';
    case SUBFLOW = 'subflow';

    /**
     * 获取用户友好的标签
     * @return string
     */
    public function label(): string
    {
        return match ($this) {
            self::MAIN    => '主流程',
            self::SUBFLOW => '子流程',
        };
    }
}
```
```php
<?php

declare(strict_types=1);

namespace App\Constants\Enums\Flow;

use App\Constants\Enums\BaseEnumTrait;
use App\Constants\Enums\EnumInterface;

enum Status: string implements EnumInterface
{
    use BaseEnumTrait;

    // 进行时状态（正在处理）
    case PROCESSING = 'processing';
    case WAITING    = 'waiting';

    // 过去式状态（已完成处理）
    case CREATED  = 'created';
    case APPROVED = 'approved';
    case REJECTED = 'rejected';
    case CANCELED = 'canceled';

    /**
     * 获取用户友好的标签
     * @return string
     */
    public function label(): string
    {
        return match ($this) {
            self::CREATED    => '已创建',
            self::PROCESSING => '进行中',
            self::WAITING    => '等待中',
            self::APPROVED   => '已通过',
            self::REJECTED   => '已驳回',
            self::CANCELED   => '已取消',
        };
    }
}
```
```php
<?php

declare(strict_types=1);

namespace App\Constants\Enums\FlowNode;

use App\Constants\Enums\BaseEnumTrait;
use App\Constants\Enums\EnumInterface;

enum Mode: string implements EnumInterface
{
    use BaseEnumTrait;

    case All        = 'all';
    case Any        = 'any';
    case SEQUENTIAL = 'sequential';

    /**
     * 获取用户友好的标签
     * @return string
     */
    public function label(): string
    {
        return match ($this) {
            self::All        => '会签',
            self::Any        => '或签',
            self::SEQUENTIAL => '依次审批',
        };
    }
}
```
```php
<?php

declare(strict_types=1);

namespace App\Constants\Enums\FlowNode;

use App\Constants\Enums\BaseEnumTrait;
use App\Constants\Enums\EnumInterface;

enum Status: string implements EnumInterface
{
    use BaseEnumTrait;

    // 进行时状态（正在处理）
    case PROCESSING = 'processing';

    // 过去式状态（已完成处理）
    case APPROVED = 'approved';
    case REJECTED = 'rejected';
    case SKIPPED  = 'skipped';
    case AUTO     = 'auto';
    case CANCELED = 'canceled';

    /**
     * 获取用户友好的标签
     * @return string
     */
    public function label(): string
    {
        return match ($this) {
            self::PROCESSING => '进行中',
            self::APPROVED   => '已通过',
            self::REJECTED   => '已驳回',
            self::SKIPPED    => '已跳过',
            self::AUTO       => '自动处理',
            self::CANCELED   => '已取消',
        };
    }
}
```
```php
<?php

declare(strict_types=1);

namespace App\Constants\Enums\FlowNode;

use App\Constants\Enums\BaseEnumTrait;
use App\Constants\Enums\EnumInterface;

enum Type: string implements EnumInterface
{
    use BaseEnumTrait;

    case START           = 'start';
    case APPROVAL        = 'approval';
    case CC              = 'cc';
    case CONDITION       = 'condition';
    case CONDITION_ROUTE = 'condition_route';
    case SUBFLOW         = 'subflow';
    case END             = 'end';


    /**
     * 获取用户友好的标签
     * @return string
     */
    public function label(): string
    {
        return match ($this) {
            self::START           => '开始节点',
            self::CONDITION       => '条件节点',
            self::CONDITION_ROUTE => '条件路由节点',
            self::APPROVAL        => '审核节点',
            self::CC              => '抄送节点',
            self::SUBFLOW         => '子流程节点',
            self::END             => '结束节点',
        };
    }
}
```
```php
<?php

declare(strict_types=1);

namespace App\Constants\Enums\FlowNodeTask;

use App\Constants\Enums\BaseEnumTrait;
use App\Constants\Enums\EnumInterface;

enum Status: string implements EnumInterface
{
    use BaseEnumTrait;

    // 进行时状态（正在处理）
    case PENDING = 'pending';

    // 过去式状态（已完成处理）
    case APPROVED    = 'approved';
    case REJECTED    = 'rejected';
    case TRANSFERRED = 'transferred';
    case FORWARDED   = 'forwarded';
    case ADD_SIGNED  = 'add_signed';
    case SKIPPED     = 'skipped';
    case AUTO        = 'auto';
    case CANCELED    = 'canceled';

    /**
     * 获取用户友好的标签
     * @return string
     */
    public function label(): string
    {
        return match ($this) {
            self::PENDING     => '待处理',
            self::APPROVED    => '已同意',
            self::REJECTED    => '已拒绝',
            self::TRANSFERRED => '已转让',
            self::FORWARDED   => '已转交',
            self::ADD_SIGNED  => '已加签',
            self::SKIPPED     => '已跳过',
            self::AUTO        => '自动',
            self::CANCELED    => '已取消',
        };
    }
}
```
```php
<?php

declare(strict_types=1);

namespace App\Constants\Enums\FlowNodeTemplate;

use App\Constants\Enums\BaseEnumTrait;
use App\Constants\Enums\EnumInterface;

enum Type: string implements EnumInterface
{
    use BaseEnumTrait;

    case START           = 'start';
    case APPROVAL        = 'approval';
    case CC              = 'cc';
    case CONDITION       = 'condition';
    case CONDITION_ROUTE = 'condition_route';
    case SUBFLOW         = 'subflow';
    case END             = 'end';

    /**
     * 获取用户友好的标签
     * @return string
     */
    public function label(): string
    {
        return match ($this) {
            self::START           => '开始节点',
            self::CONDITION       => '条件节点',
            self::CONDITION_ROUTE => '条件路由节点',
            self::APPROVAL        => '审核节点',
            self::CC              => '抄送节点',
            self::SUBFLOW         => '子流程节点',
            self::END             => '结束节点',
        };
    }
}
```
```php
<?php

declare(strict_types=1);

namespace App\Constants\Enums\FlowTemplate;

use App\Constants\Enums\BaseEnumTrait;
use App\Constants\Enums\EnumInterface;

enum Status: string implements EnumInterface
{
    use BaseEnumTrait;

    case ENABLE  = 'enable';
    case DISABLE = 'disable';

    /**
     * 获取用户友好的标签
     * @return string
     */
    public function label(): string
    {
        return match ($this) {
            self::ENABLE  => '启用',
            self::DISABLE => '禁用',
        };
    }
}
```
```php
<?php

declare(strict_types=1);

namespace App\Constants\Enums\FlowTemplate;

use App\Constants\Enums\BaseEnumTrait;
use App\Constants\Enums\EnumInterface;

enum Type: string implements EnumInterface
{
    use BaseEnumTrait;

    case GENERAL = 'general';

    /**
     * 获取用户友好的标签
     * @return string
     */
    public function label(): string
    {
        return match ($this) {
            self::GENERAL => '通用审批',
        };
    }
}
```
```php
<?php

namespace App\Constants\Enums;

use Illuminate\Support\Arr;

trait BaseEnumTrait
{
    /**
     * 获取所有值的数组
     * @return array
     */
    public static function values(): array
    {
        return Arr::pluck(self::cases(), 'value');
    }
}
```
```php
<?php

namespace App\Constants\Enums;

interface EnumInterface
{
    /**
     * 获取用户友好的标签
     * @return string
     */
    public function label(): string;

    /**
     * 获取所有值的数组
     * @return array
     */
    public static function values(): array;
}
```

### 3、模型
```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Concerns\HasUlids;
use Illuminate\Database\Eloquent\Model;
use Service\Common\Base\ResourceModelInterface;

class BaseModel extends Model implements ResourceModelInterface
{
    use HasUlids;

    /** @var string 与表关联的主键 */
    protected $primaryKey = 'id';

    /** @var bool 表明模型的 ID 是否自增 */
    public $incrementing = false;

    /** @var string 主键 ID 的数据类型 */
    protected $keyType = 'string';

    /** @var array 不可被批量赋值的属性（黑名单） */
    protected $guarded = [];

    protected array $resource = [];

    protected function serializeDate(\DateTimeInterface $date): string
    {
        return $date->format($this->dateFormat ?: 'Y-m-d H:i:s');
    }

    public function getResource(): array
    {
        return $this->resource;
    }
}
```
```php
<?php

declare(strict_types=1);

namespace App\Models;

use Illuminate\Database\Eloquent\SoftDeletes;

/**
 * @property string $id
 * @property string $title
 * @property string $type
 * @property string $code
 * @property string $parent_flow_id
 * @property string $parent_node_id
 * @property string $business_id
 * @property array $business_snapshot
 * @property string $level
 * @property string $status
 * @property array $flow_node_template_snapshot
 * @property array $callback
 * @property string $applicant_type
 * @property string $applicant_id
 * @property array $extend
 * @property string $flow_template_id
 * @property string $created_at
 * @property string $updated_at
 * @property string $deleted_at
 */
class Flow extends BaseModel
{
    use SoftDeletes;

    protected $table = 'flow';

    protected $casts = [
        'business_snapshot'           => 'json',
        'flow_node_template_snapshot' => 'json',
        'callback'                    => 'json',
        'extend'                      => 'json',
    ];

    protected array $resource = [
        'id'                          => 'string',
        'title'                       => 'string',
        'type'                        => 'string',
        'code'                        => 'string',
        'parent_flow_id'              => 'string',
        'parent_node_id'              => 'string',
        'level'                       => 'string',
        'business_id'                 => 'string',
        'business_snapshot'           => 'array',
        'status'                      => 'string',
        'flow_node_template_snapshot' => 'array',
        'callback'                    => 'array',
        'applicant_type'              => 'string',
        'applicant_id'                => 'string',
        'extend'                      => 'array',
        'flow_template_id'            => 'string',
        'created_at'                  => 'string',
        'updated_at'                  => 'string',
        'deleted_at'                  => 'string',
    ];
}
```
```php
<?php

declare(strict_types=1);

namespace App\Models;

use Illuminate\Database\Eloquent\SoftDeletes;

/**
 * @property string $id
 * @property string $parent_id
 * @property string $type
 * @property int $depth
 * @property int $priority
 * @property string $name
 * @property string $rules
 * @property string $status
 * @property array $callback
 * @property string $flow_id
 * @property array $extend
 * @property string $created_at
 * @property string $updated_at
 * @property string $deleted_at
 */
class FlowNode extends BaseModel
{
    use SoftDeletes;

    protected $table = 'flow_node';

    protected $casts = [
        'rules'    => 'json',
        'callback' => 'json',
        'extend'   => 'json',
    ];

    protected array $resource = [
        'id'         => 'string',
        'parent_id'  => 'string',
        'depth'      => 'int',
        'priority'   => 'int',
        'name'       => 'string',
        'type'       => 'string',
        'rules'      => 'array',
        'status'     => 'string',
        'callback'   => 'array',
        'flow_id'    => 'string',
        'extend'     => 'array',
        'created_at' => 'string',
        'updated_at' => 'string',
        'deleted_at' => 'string',
    ];
}
```
```php
<?php

declare(strict_types=1);

namespace App\Models;

use Illuminate\Database\Eloquent\SoftDeletes;

/**
 * @property string $id
 * @property string $approval_id
 * @property string $approver_name
 * @property string $approver_type
 * @property array $operation_info
 * @property string $status
 * @property string $flow_node_id
 * @property array $extend
 * @property string $created_at
 * @property string $created_admin_id
 * @property string $updated_at
 * @property string $updated_admin_id
 * @property string $deleted_at
 * @property string $deleted_admin_id
 */
class FlowNodeTask extends BaseModel
{
    use SoftDeletes;

    protected $table = 'flow_node_task';

    protected $casts = [
        'operation_info' => 'json',
        'extend'         => 'json',
    ];

    protected array $resource = [
        'id'               => 'string',
        'approver_id'      => 'string',
        'approver_name'    => 'string',
        'approver_type'    => 'string',
        'operation_info'   => 'array',
        'status'           => 'string',
        'flow_node_id'     => 'string',
        'extend'           => 'array',
        'created_at'       => 'string',
        'created_admin_id' => 'string',
        'updated_at'       => 'string',
        'updated_admin_id' => 'string',
        'deleted_at'       => 'string',
        'deleted_admin_id' => 'string',
    ];
}
```
```php
<?php

declare(strict_types=1);

namespace App\Models;

use App\Constants\Enums\FlowNodeTemplate\Type;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Illuminate\Database\Eloquent\Relations\HasOne;
use Illuminate\Database\Eloquent\SoftDeletes;

/**
 * @property string $id
 * @property string $parent_id
 * @property int $depth
 * @property int $priority
 * @property string $name
 * @property string $description
 * @property string $type
 * @property string $rules
 * @property array $callback
 * @property string $flow_template_id
 * @property string $created_at
 * @property string $created_admin_id
 * @property string $updated_at
 * @property string $updated_admin_id
 * @property string $deleted_at
 * @property string $deleted_admin_id
 */
class FlowNodeTemplate extends BaseModel
{
    use SoftDeletes;

    protected $table = 'flow_node_template';

    protected $casts = [
        'rules'    => 'json',
        'callback' => 'json',
    ];

    protected array $resource = [
        'id'               => 'string',
        'parent_id'        => 'string',
        'depth'            => 'int',
        'priority'         => 'int',
        'name'             => 'string',
        'description'      => 'string',
        'type'             => 'string',
        'rules'            => 'array',
        'callback'         => 'array',
        'flow_template_id' => 'string',
    ];

    /**
     * 子节点
     * @return HasOne
     */
    public function children(): HasOne
    {
        return $this->hasOne(self::class, 'parent_id', 'id')
            ->whereNot('type', Type::CONDITION->value)
            ->with(['children', 'conditionNode']);
    }

    /**
     * 条件节点
     * @return HasMany
     */
    public function conditionNode(): HasMany
    {
        return $this->hasMany(self::class, 'parent_id', 'id')
            ->where('type', Type::CONDITION->value)
            ->with(['children', 'conditionNode']);
    }
}
```
```php
<?php

declare(strict_types=1);

namespace App\Models;

use Illuminate\Database\Eloquent\Relations\HasOne;
use Illuminate\Database\Eloquent\SoftDeletes;

/**
 * @property string $id
 * @property string $type
 * @property string $code
 * @property string $name
 * @property array $callback
 * @property string $remark
 * @property string $status
 * @property string $created_at
 * @property string $created_admin_id
 * @property string $updated_at
 * @property string $updated_admin_id
 * @property string $deleted_at
 * @property string $deleted_admin_id
 */
class FlowTemplate extends BaseModel
{
    use SoftDeletes;

    protected $table = 'flow_template';

    protected $casts = [
        'callback' => 'json',
    ];

    protected array $resource = [
        'id'       => 'string',
        'type'     => 'string',
        'code'     => 'string',
        'name'     => 'string',
        'callback' => 'array',
        'remark'   => 'string',
        'status'   => 'string',
    ];

    /**
     * @return HasOne
     */
    public function nodeTemplate(): HasOne
    {
        return $this->hasOne(FlowNodeTemplate::class, 'flow_template_id', 'id')->whereNull('parent_id');
    }
}
```
### 4、仓库层
```php
<?php

declare(strict_types=1);

namespace App\Repositories;

use App\Models\FlowNode;
use Illuminate\Support\Arr;
use Service\Common\Base\BaseRepository;

class FlowNodeRepositories extends BaseRepository
{
    public function __construct(FlowNode $model)
    {
        $this->model = $model;
    }

    /**
     * 创建
     * @param  array  $inputs
     * @return FlowNode
     * @throws \Exception
     */
    public function store(array $inputs): FlowNode
    {
        if (empty($inputs)) {
            throw new \Exception('参数错误');
        }

        return $this->query()->create([
            'parent_id' => Arr::get($inputs, 'parent_id'),
            'depth'     => Arr::get($inputs, 'depth'),
            'name'      => Arr::get($inputs, 'name'),
            'type'      => Arr::get($inputs, 'type'),
            'rules'     => Arr::get($inputs, 'rules'),
            'status'    => Arr::get($inputs, 'status'),
            'callback'  => empty($inputs['callback']) ? null : $inputs['callback'],
            'flow_id'   => Arr::get($inputs, 'flow_id'),
            'extend'    => Arr::get($inputs, 'extend'),
        ]);
    }

    /**
     * 更新
     * @param  string  $id
     * @param  array  $inputs
     * @return int
     * @throws \Exception
     */
    public function update(string $id, array $inputs): int
    {
        if (empty($inputs)) {
            throw new \Exception('参数错误');
        }

        return $this->query()->where('id', $id)->update([
            'status' => Arr::get($inputs, 'status'),
            'extend' => Arr::get($inputs, 'extend'),
        ]);
    }
}
```
```php
<?php

declare(strict_types=1);

namespace App\Repositories;

use App\Models\FlowNodeTask;
use Illuminate\Support\Arr;
use Service\Common\Base\BaseRepository;

class FlowNodeTaskRepositories extends BaseRepository
{
    public function __construct(FlowNodeTask $model)
    {
        $this->model = $model;
    }

    /**
     * 创建
     * @param  array  $inputs
     * @return FlowNodeTask
     * @throws \Exception
     */
    public function store(array $inputs): FlowNodeTask
    {
        if (empty($inputs)) {
            throw new \Exception('参数错误');
        }

        return $this->query()->create([
            'approver_id'    => Arr::get($inputs, 'approver_id'),
            'approver_name'  => Arr::get($inputs, 'approver_name'),
            'approver_type'  => Arr::get($inputs, 'approver_type'),
            'operation_info' => empty($inputs['operation_info']) ? null : $inputs['operation_info'],
            'status'         => Arr::get($inputs, 'status'),
            'flow_node_id'   => Arr::get($inputs, 'flow_node_id'),
            'extend'         => Arr::get($inputs, 'extend'),
        ]);
    }

    /**
     * 更新
     * @param  string  $id
     * @param  array  $inputs
     * @return int
     * @throws \Exception
     */
    public function update(string $id, array $inputs): int
    {
        if (empty($inputs)) {
            throw new \Exception('参数错误');
        }

        return $this->query()->where('id', $id)->update([
            'operation_info' => empty($inputs['operation_info']) ? null : $inputs['operation_info'],
            'status'         => Arr::get($inputs, 'status'),
            'extend'         => Arr::get($inputs, 'extend'),
        ]);
    }
}
```
```php
<?php

declare(strict_types=1);

namespace App\Repositories;

use App\Models\FlowNodeTemplate;
use Illuminate\Support\Arr;
use Service\Common\Base\BaseRepository;

class FlowNodeTemplateRepositories extends BaseRepository
{
    public function __construct(FlowNodeTemplate $model)
    {
        $this->model = $model;
    }

    /**
     * 创建
     * @param  array  $inputs
     * @return FlowNodeTemplate
     * @throws \Exception
     */
    public function store(array $inputs): FlowNodeTemplate
    {
        if (empty($inputs)) {
            throw new \Exception('参数错误');
        }

        return $this->query()->create([
            'parent_id'        => Arr::get($inputs, 'parent_id'),
            'depth'            => Arr::get($inputs, 'depth'),
            'priority'         => Arr::get($inputs, 'priority'),
            'name'             => Arr::get($inputs, 'name'),
            'description'      => Arr::get($inputs, 'description'),
            'type'             => Arr::get($inputs, 'type'),
            'rules'            => empty($inputs['rules']) ? null : $inputs['rules'],
            'callback'         => empty($inputs['callback']) ? null : $inputs['callback'],
            'flow_template_id' => Arr::get($inputs, 'flow_template_id'),
        ]);
    }

    /**
     * 更新
     * @param  string  $id
     * @param  array  $inputs
     * @return int
     * @throws \Exception
     */
    public function update(string $id, array $inputs): int
    {
        if (empty($inputs)) {
            throw new \Exception('参数错误');
        }

        return $this->query()->where('id', $id)->update([
            'parent_id'        => Arr::get($inputs, 'parent_id'),
            'depth'            => Arr::get($inputs, 'depth'),
            'priority'         => Arr::get($inputs, 'priority'),
            'name'             => Arr::get($inputs, 'name'),
            'description'      => Arr::get($inputs, 'description'),
            'type'             => Arr::get($inputs, 'type'),
            'rules'            => empty($inputs['rules']) ? null : $inputs['rules'],
            'callback'         => empty($inputs['callback']) ? null : $inputs['callback'],
            'flow_template_id' => Arr::get($inputs, 'flow_template_id'),
        ]);
    }

    /**
     * 根据flowTemplateId获取ID
     * @param  string  $flowTemplateId
     * @return array
     */
    public function findIdByFlowTemplateId(string $flowTemplateId): array
    {
        return $this->query()->where('flow_template_id', $flowTemplateId)->pluck('id')->toArray();
    }
}
```
```php
<?php

declare(strict_types=1);

namespace App\Repositories;

use App\Models\Flow;
use Illuminate\Support\Arr;
use Service\Common\Base\BaseRepository;

class FlowRepositories extends BaseRepository
{
    public function __construct(Flow $model)
    {
        $this->model = $model;
    }

    /**
     * 创建
     * @param  array  $inputs
     * @return Flow
     * @throws \Exception
     */
    public function store(array $inputs): Flow
    {
        if (empty($inputs)) {
            throw new \Exception('参数错误');
        }

        return $this->query()->create([
            'title'                       => Arr::get($inputs, 'title'),
            'type'                        => Arr::get($inputs, 'type'),
            'code'                        => Arr::get($inputs, 'code'),
            'parent_flow_id'              => Arr::get($inputs, 'parent_flow_id'),
            'parent_node_id'              => Arr::get($inputs, 'parent_node_id'),
            'level'                       => Arr::get($inputs, 'level'),
            'business_id'                 => Arr::get($inputs, 'business_id'),
            'business_snapshot'           => Arr::get($inputs, 'business_snapshot'),
            'status'                      => Arr::get($inputs, 'status'),
            'flow_node_template_snapshot' => Arr::get($inputs, 'flow_node_template_snapshot'),
            'callback'                    => empty($inputs['callback']) ? null : $inputs['callback'],
            'applicant_type'              => Arr::get($inputs, 'applicant_type'),
            'applicant_id'                => Arr::get($inputs, 'applicant_id'),
            'extend'                      => Arr::get($inputs, 'extend'),
            'flow_template_id'            => Arr::get($inputs, 'flow_template_id'),
        ]);
    }

    /**
     * 更新
     * @param  string  $id
     * @param  array  $inputs
     * @return int
     * @throws \Exception
     */
    public function update(string $id, array $inputs): int
    {
        if (empty($inputs)) {
            throw new \Exception('参数错误');
        }

        return $this->query()->where('id', $id)->update([
            'status'                      => Arr::get($inputs, 'status'),
            'flow_node_template_snapshot' => Arr::get($inputs, 'flow_node_template_snapshot'),
            'extend'                      => Arr::get($inputs, 'extend'),
        ]);
    }
}
```
```php
<?php

declare(strict_types=1);

namespace App\Repositories;

use App\Constants\Enums\FlowTemplate\Status;
use App\Models\FlowTemplate;
use Illuminate\Database\Eloquent\Collection;
use Illuminate\Pagination\LengthAwarePaginator;
use Illuminate\Support\Arr;
use Service\Common\Base\BaseRepository;

class FlowTemplateRepositories extends BaseRepository
{
    public function __construct(FlowTemplate $model)
    {
        $this->model = $model;
    }

    /**
     * 分页
     * @param  array  $inputs
     * @return LengthAwarePaginator
     */
    public function page(array $inputs): LengthAwarePaginator
    {
        $query = $this->query();

        $query->when(! empty($inputs['type']), fn ($query) => $query->where('type', $inputs['type']));
        $query->when(! empty($inputs['status']), fn ($query) => $query->where('status', $inputs['status']));
        $query->when(! empty($inputs['name']), fn ($query) => $query->where('name', 'like', '%'.$inputs['name'].'%'));

        return $query->paginate($inputs['page_size']);
    }

    /**
     * 列表
     * @param  array  $inputs
     * @return Collection
     */
    public function list(array $inputs): Collection
    {
        $query = $this->query();

        $query->when(! empty($inputs['type']), fn ($query) => $query->where('type', $inputs['type']));
        $query->when(! empty($inputs['status']), fn ($query) => $query->where('status', $inputs['status']));

        return $query->get();
    }

    /**
     * 创建
     * @param  array  $inputs
     * @return FlowTemplate
     * @throws \Exception
     */
    public function store(array $inputs): FlowTemplate
    {
        if (empty($inputs)) {
            throw new \Exception('参数错误');
        }

        return $this->query()->create([
            'type'     => Arr::get($inputs, 'type'),
            'code'     => Arr::get($inputs, 'code'),
            'name'     => Arr::get($inputs, 'name'),
            'callback' => empty($inputs['callback']) ? null : $inputs['callback'],
            'remark'   => Arr::get($inputs, 'remark', ''),
            'status'   => Status::DISABLE->value,
        ]);
    }

    /**
     * 更新
     * @param  string  $id
     * @param  array  $inputs
     * @return int
     * @throws \Exception
     */
    public function update(string $id, array $inputs): int
    {
        if (empty($inputs)) {
            throw new \Exception('参数错误');
        }

        return $this->query()->where('id', $id)->update([
            'name'     => Arr::get($inputs, 'name'),
            'callback' => empty($inputs['callback']) ? null : $inputs['callback'],
            'remark'   => Arr::get($inputs, 'remark', ''),
            'status'   => Status::DISABLE->value,
        ]);
    }
}
```
### 5、控制器层

```php
<?php

declare(strict_types=1);

namespace App\Http\Controllers\Web\V1;

use App\Http\Controllers\Controller;
use App\Http\Requests\Flow\FlowRequest;
use App\Services\FlowService;
use Illuminate\Http\JsonResponse;

class FlowController extends Controller
{
    public function __construct(
        private readonly FlowService $service,
    ) {}

    /**
     * 创建审批流程
     * @param  string  $code
     * @param  FlowRequest  $request
     * @return JsonResponse
     * @throws \Throwable
     */
    public function create(string $code, FlowRequest $request)
    {
        return $this->service->create($code, $request->all());
    }

    /**
     * 提交审批流程
     * @param  string  $id
     * @param  FlowRequest  $request
     * @return JsonResponse
     * @throws \Throwable
     */
    public function submit(string $id, FlowRequest $request)
    {
        return $this->service->submit($id, $request->all());
    }
}
```
```php
<?php

declare(strict_types=1);

namespace App\Http\Controllers\Web\V1;

use App\Http\Controllers\Controller;
use App\Http\Requests\FlowNodeTask\FlowNodeTaskRequest;
use App\Services\FlowNodeTaskService;

class FlowNodeTaskController extends Controller
{
    public function __construct(
        private readonly FlowNodeTaskService $service
    ) {}

    public function approve(FlowNodeTaskRequest $request, string $id)
    {
        return $this->service->approve($id, $request->all());
    }
}
```
### 6、服务层
```php
<?php

declare(strict_types=1);

namespace App\Services;

use Illuminate\Http\JsonResponse;
use Illuminate\Support\Facades\DB;
use Service\Common\Library\Response\ApiResponse;

readonly class FlowService
{
    public function __construct() {}

    /**
     * 创建审批流程
     * @param  string  $code
     * @param  array  $inputs
     * @return JsonResponse
     * @throws \Throwable
     */
    public function create(string $code, array $inputs): JsonResponse
    {
        DB::beginTransaction();
        try {

            DB::commit();

            return ApiResponse::success();
        } catch (\Exception $e) {
            DB::rollBack();

            return ApiResponse::fail(message: $e->getMessage());
        }
    }

    /**
     * 提交审批流程
     * @param  string  $id
     * @param  array  $inputs
     * @return JsonResponse
     * @throws \Throwable
     */
    public function submit(string $id, array $inputs): JsonResponse
    {
        DB::beginTransaction();
        try {

            DB::commit();

            return ApiResponse::success();
        } catch (\Exception $e) {
            DB::rollBack();

            return ApiResponse::fail(message: $e->getMessage());
        }
    }
}
```
```php
<?php

declare(strict_types=1);

namespace App\Services;

use Illuminate\Http\JsonResponse;
use Service\Common\Library\Response\ApiResponse;

readonly class FlowNodeTaskService
{
    public function __construct() {}

    /**
     * 审批
     * @param  string  $id
     * @param  array  $inputs
     * @return JsonResponse
     */
    public function approve(string $id, array $inputs): JsonResponse
    {
        try {
            return ApiResponse::success();
        } catch (\Exception $e) {
            return ApiResponse::fail(message: $e->getMessage());
        }
    }
}
```
### 7、审批模版
```json
{
    "id": "01k562yzzakavqeq3yvwb0bs7b",
    "type": "general",
    "code": "partner",
    "name": "测试",
    "callback": [],
    "remark": "",
    "status": "enable",
    "node_template": {
        "id": "01k562yzzvd6f6td4f8aagz70c",
        "parent_id": "",
        "depth": 1,
        "priority": 0,
        "name": "开始节点",
        "description": "开始节点,开始节点",
        "type": "start",
        "rules": [],
        "callback": [],
        "flow_template_id": "01k562yzzakavqeq3yvwb0bs7b",
        "children": {
            "id": "01k562z00aeesb0ad2cbs9pndp",
            "parent_id": "01k562yzzvd6f6td4f8aagz70c",
            "depth": 2,
            "priority": 0,
            "name": "审核节点1",
            "description": "审核节点1,审核节点1",
            "type": "approval",
            "rules": {
                "approval_method": "all"
            },
            "callback": [],
            "flow_template_id": "01k562yzzakavqeq3yvwb0bs7b",
            "children": {
                "id": "01k562z00r71s45y58e85v31gw",
                "parent_id": "01k562z00aeesb0ad2cbs9pndp",
                "depth": 3,
                "priority": 0,
                "name": "条件路由",
                "description": "",
                "type": "condition_route",
                "rules": [],
                "callback": [],
                "flow_template_id": "01k562yzzakavqeq3yvwb0bs7b",
                "children": {
                    "id": "01k562z03fgkgx0zr12tmw742k",
                    "parent_id": "01k562z00r71s45y58e85v31gw",
                    "depth": 4,
                    "priority": 0,
                    "name": "审核节点4",
                    "description": "审核节点4,审核节点4",
                    "type": "approval",
                    "rules": {
                        "approval_method": "all"
                    },
                    "callback": [],
                    "flow_template_id": "01k562yzzakavqeq3yvwb0bs7b",
                    "children": {
                        "id": "01k562z03xa7ntnbtdsp0dsvzb",
                        "parent_id": "01k562z03fgkgx0zr12tmw742k",
                        "depth": 5,
                        "priority": 0,
                        "name": "抄送节点",
                        "description": "抄送节点,抄送节点",
                        "type": "cc",
                        "rules": [],
                        "callback": [],
                        "flow_template_id": "01k562yzzakavqeq3yvwb0bs7b",
                        "children": {
                            "id": "01k562z04cwm3gx26gkhnt5t51",
                            "parent_id": "01k562z03xa7ntnbtdsp0dsvzb",
                            "depth": 6,
                            "priority": 0,
                            "name": "结束节点",
                            "description": "",
                            "type": "end",
                            "rules": [],
                            "callback": [],
                            "flow_template_id": "01k562yzzakavqeq3yvwb0bs7b",
                            "children": null,
                            "condition_node": []
                        },
                        "condition_node": []
                    },
                    "condition_node": []
                },
                "condition_node": [
                    {
                        "id": "01k562z01byh5ka8daq498d4vv",
                        "parent_id": "01k562z00r71s45y58e85v31gw",
                        "depth": 3,
                        "priority": 2,
                        "name": "条件节点",
                        "description": "条件节点,条件节点",
                        "type": "condition",
                        "rules": [],
                        "callback": [],
                        "flow_template_id": "01k562yzzakavqeq3yvwb0bs7b",
                        "children": {
                            "id": "01k562z01sfmrk95aj7th1tj20",
                            "parent_id": "01k562z01byh5ka8daq498d4vv",
                            "depth": 4,
                            "priority": 0,
                            "name": "审核节点2",
                            "description": "审核节点2,审核节点2",
                            "type": "approval",
                            "rules": {
                                "approval_method": "all"
                            },
                            "callback": [],
                            "flow_template_id": "01k562yzzakavqeq3yvwb0bs7b",
                            "children": null,
                            "condition_node": []
                        },
                        "condition_node": []
                    },
                    {
                        "id": "01k562z02ajaxwtvkjr8r2fc17",
                        "parent_id": "01k562z00r71s45y58e85v31gw",
                        "depth": 3,
                        "priority": 1,
                        "name": "默认条件",
                        "description": "默认条件,默认条件",
                        "type": "condition",
                        "rules": [],
                        "callback": [],
                        "flow_template_id": "01k562yzzakavqeq3yvwb0bs7b",
                        "children": {
                            "id": "01k562z031zx475q7ewb8gc1tr",
                            "parent_id": "01k562z02ajaxwtvkjr8r2fc17",
                            "depth": 4,
                            "priority": 0,
                            "name": "审核节点3",
                            "description": "审核节点3,审核节点3",
                            "type": "approval",
                            "rules": {
                                "approval_method": "all"
                            },
                            "callback": [],
                            "flow_template_id": "01k562yzzakavqeq3yvwb0bs7b",
                            "children": null,
                            "condition_node": []
                        },
                        "condition_node": []
                    }
                ]
            },
            "condition_node": []
        },
        "condition_node": []
    }
}
```
